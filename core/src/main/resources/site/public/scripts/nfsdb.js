/*******************************************************************************
 *  _  _ ___ ___     _ _
 * | \| | __/ __| __| | |__
 * | .` | _|\__ \/ _` | '_ \
 * |_|\_|_| |___/\__,_|_.__/
 *
 * Copyright (c) 2014-2016. The NFSdb project and its contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/

"use strict";function s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function toSize(e){return 1024>e?e:1048576>e?Math.round(e/1024)+"KB":1073741824>e?Math.round(e/1024/1024)+"MB":Math.round(e/1024/1024/1024)+"GB"}function nopropagation(e){e.stopPropagation(),e.preventDefault&&e.preventDefault()}function localStorageSupport(){return"localStorage"in window&&null!==window.localStorage}function fixHeight(){var e=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",e+"px");var t=$("nav.navbar-default").height(),a=$("#page-wrapper"),n=a.height();t>n&&a.css("min-height",t+"px"),n>t&&a.css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(t>n?a.css("min-height",t-60+"px"):a.css("min-height",$(window).height()-60+"px"))}!function(e){e.fn.importManager=function(){function t(t){if(t.lengthComputable){var a=t.loaded||t.position;e("#"+j.id).find(" > .ud-progress").css("width",100*a/j.size+"%")}}function a(){var a=e.ajaxSettings.xhr();return a.upload&&a.upload.addEventListener("progress",t,!1),a}function n(){var t=!1;for(var a in x)if(x.hasOwnProperty(a)&&x[a].selected){t=!0;break}e("#btnImportClearSelected").attr("disabled",!t)}function i(){e("#btnImportCancel").attr("disabled",null===j)}function o(){var t=e(this).parent().attr("id"),a=e("#"+t).find(".fa"),i=x[t];i.selected=!i.selected,i.selected?a.removeClass("fa-square-o").addClass("fa-check-square-o"):a.removeClass("fa-check-square-o").addClass("fa-square-o"),n()}function s(t){var a=x[e(this).parent().attr("id")];a.importState>-1&&e(document).trigger("import.detail",a),nopropagation(t)}function r(t){w.append('<div id="'+t.id+'" class="ud-row" style="top: '+S+'px;"><div class="ud-cell ud-c0"><i class="fa fa-square-o ud-checkbox"></i></div><div class="ud-cell ud-c1">'+t.name+'</div><div class="ud-cell ud-c2">'+t.sizeFmt+'</div><div class="ud-cell ud-c3"><span class="label">pending</span></div></div>');var a=e("#"+t.id);a.find(".ud-c0").click(o),a.find(".ud-c1").click(s),a.find(".ud-c2").click(s),a.find(".ud-c3").click(s),S+=I}function l(t,a,n){var o=e("#"+t.id);if(o.find(" > .ud-c3").html(a),o.find(" > .ud-progress").remove(),n){var s=T.shift();s?g(s):(j=null,z=null)}i()}function d(e){j.response=e,j.importState=0,l(j,'<span class="label label-success">imported</span>',!0)}function c(e){switch(e){case 0:return 3;case 400:return 4;case 500:return 5;default:return 101}}function u(e){j.response=e.responseText,"abort"!==e.statusText?(j.importState=c(e.status),l(j,'<span class="label label-danger">failed</span>',!0)):(j.importState=-2,l(j,'<span class="label label-warning">aborted</span>',!0))}function p(){return q.xhr=a,q.data=new FormData,q.data.append("data",j.file),q}function f(){l(j,'<span class="label label-info">importing</span>',!1),e("#"+j.id).append('<div class="ud-progress"></div>'),z=e.ajax(p()).done(d).fail(u),i()}function m(e){switch(e.status){case"EXISTS":j.importState=1,l(j,'<span class="label label-danger">exists</span>',!0);break;case"DOES_NOT_EXIST":j.importState=0,f();break;case"EXISTS_FOREIGN":j.importState=2,l(j,'<span class="label label-danger">reserved</span>',!0);break;default:j.importState=101,l(j,'<span class="label label-danger">failed</span>',!0)}}function g(t){j=t,E.url="/chk?f=json&j="+t.name,e.ajax(E).then(m).fail(u)}function h(e,t){for(var a=0;a<t.files.length;a++){var n=t.files[a],i={id:guid(),name:n.name,size:n.size,file:n,sizeFmt:toSize(n.size),selected:!1,imported:!1};x[i.id]=i,r(i),null!=j?T.push(i):g(i)}}function v(){for(var t in x)if(x.hasOwnProperty(t)){var a=x[t];if(a.selected&&a!==j){var i=T.indexOf(a);i>-1&&delete T[i],e("#"+t).remove(),delete x[t],e(document).trigger("import.cleared",a)}}S=0;for(var o=w.find(".ud-row"),s=0;s<o.length;s++)e(o[s]).css("top",S),S+=I;n()}function b(){null!==z&&z.abort()}function $(t,a){e("#"+a+" > .ud-c1").html(x[a].name+'<span class="label label-danger m-l-lg">overwrite</span>')}function y(t,a){e("#"+a+" > .ud-c1").html(x[a].name+'<span class="label label-primary m-l-lg">append</span>')}function C(t,a){e("#"+a+" > .ud-c1").html(x[a].name)}var w,x={},k=this,S=0,T=[],j=null,I=35,z=null,q={xhr:a,url:"/imp?fmt=json",type:"POST",contentType:!1,processData:!1,cache:!1},E={type:"GET",contentType:!1,processData:!1,cache:!1};return k.append('<div class="ud-header-row"><div class="ud-header ud-h0">&nbsp;</div><div class="ud-header ud-h1">File name</div><div class="ud-header ud-h2">Size</div><div class="ud-header ud-h3">Status</div></div>'),k.append('<div class="ud-canvas"></div>'),w=k.find("> .ud-canvas"),e(document).on("dropbox.files",h),e(document).on("import.clearSelected",v),e(document).on("import.cancel",b),e(document).on("import.line.overwrite",$),e(document).on("import.line.append",y),e(document).on("import.line.cancel",C),this},e.fn.dropbox=function(){function t(){o.addClass("drag-drop").removeClass("drag-idle")}function a(){o.removeClass("drag-drop").addClass("drag-idle")}function n(){o.on("drop",function(t){a(),i=e(),e(document).trigger("dropbox.files",t.originalEvent.dataTransfer)}),o.each(function(){var n=e(this);n.on("dragenter",function(e){0===i.size()&&(nopropagation(e),t()),i=i.add(e.target)}),n.on("dragleave",function(e){setTimeout(function(){i=i.not(e.target),0===i.size()&&a()},1)})})}var i=e(),o=this;return n(),this}}(jQuery),$(document).ready(function(){$("#btnImportClearSelected").click(function(){$(document).trigger("import.clearSelected")}),$("#btnImportCancel").click(function(){$(document).trigger("import.cancel")}),$("#btnRetry").click(function(){$(document).trigger("import.retry")}),$("#dragTarget").dropbox(),$("#import-file-list").importManager(),$(document).on("dragenter",nopropagation),$(document).on("dragover",nopropagation),$(document).on("drop",nopropagation),$(document).ready(function(){$("input").iCheck({checkboxClass:"icheckbox_square-red",radioClass:"iradio_square-red"})})}),function(e){e.fn.importEditor=function(){function t(){var t=e(this);d.appendTo(t.parent()),d.css("left",t.css("left")),d.css("width",t.css("width"));var a=parseInt(e(this).parent().find(".js-g-row").text())-1,n=k.response.columns[a];n.altType?d.val(n.altType):d.val(n.type),d.changeTargetDiv=t,d.changeTargetCol=n,d.show(),d.focus()}function a(){d.hide()}function n(e){return e.altType&&e.altType!==e.type?e.type+'<i class="fa fa-angle-double-right g-type-separator"></i>'+e.altType:e.type}function i(){for(var t=!1,a=0;a<k.response.columns.length;a++){var n=k.response.columns[a];if(n.altType&&n.type!==n.altType){t=!0;break}}e(document).trigger(t?"import.line.overwrite":"import.line.cancel",k.id)}function o(){d.changeTargetCol.altType=e(this).find("option:selected").text(),d.changeTargetDiv.html(n(d.changeTargetCol)),i(),a()}function s(){e(".g-type").click(t),e(".g-other").click(a),d.change(o)}function r(e){if(e.response&&0===e.importState){g.html(e.response.location);var t=e.response.rowsImported,a=e.response.rowsRejected,i=t+a;if(h.css("width",Math.round(100*a/i)+"%"),v.css("width",Math.round(100*t/i)+"%"),b.html(a),$.html(t),y.empty(),e.response.columns)for(var o=0,r=0;r<e.response.columns.length;r++){var l=e.response.columns[r];y.append('<div class="ud-row" style="top: '+o+'px"><div class="ud-cell gc-1 g-other js-g-row">'+(r+1)+'</div><div class="ud-cell gc-2 g-other">'+(l.errors>0?'<i class="fa fa-exclamation-triangle g-warning"></i>':"")+l.name+'</div><div class="ud-cell gc-3 g-type">'+n(l)+'</div><div class="ud-cell gc-4 g-other">'+l.errors+"</div></div>"),o+=w}s(),p.show(),f.hide()}else{switch(e.importState){case 1:m.html("Journal <strong>"+e.name+"</strong> already exists on server"),C.show();break;case 2:m.html("Journal name <strong>"+e.name+"</strong> is reserved"),C.hide();break;case 3:m.html("Server is not responding..."),C.hide();break;case 4:m.html("Server rejected file due to unsupported file format."),C.hide();break;case 5:m.html("Server encountered internal problem. Check server logs for more details."),C.hide();break;default:m.html("Unknown error: "+e.responseStatus),C.hide()}p.hide(),f.show()}c.show()}function l(){d=e('<select class="g-dynamic-select form-control m-b"/>');for(var t=0;t<x.length;t++){var a=x[t];e("<option />",{value:a,text:a}).appendTo(d)}}var d,c=e(this),u=e(".stats-switcher"),p=e(this).find(".js-import-editor"),f=e(this).find(".js-import-error"),m=e(this).find(".js-message"),g=e(this).find(".js-import-tab-name"),h=e(this).find(".import-rejected"),v=e(this).find(".import-imported"),b=e(this).find(".js-rejected-row-count"),$=e(this).find(".js-imported-row-count"),y=e(this).find(".ud-canvas"),C=e(this).find(".js-import-error-btn-group"),w=35,x=["BOOLEAN","BYTE","DOUBLE","FLOAT","INT","LONG","SHORT","STRING","SYMBOL","DATE"],k=null;e(document).on("import.detail",function(e,t){k=t,r(t)}),e(document).on("import.cleared",function(e,t){t===k&&(k=null,p.hide())}),l(),e(".import-stats-chart").click(function(){u.hasClass("stats-visible")?u.removeClass("stats-visible"):u.addClass("stats-visible")}),e('input:radio[name="importAction"]').on("ifClicked",function(){var t;switch(this.value){case"append":t="import.line.append";break;case"overwrite":t="import.line.overwrite";break;default:t="import.line.cancel"}e(document).trigger(t,k.id)})}}(jQuery),$(document).ready(function(){$("#import-detail").importEditor()}),function(e){function t(){function t(){}function a(){null!==d&&(d.abort(),d=null)}function n(){null!==c&&(clearTimeout(c),c=null)}function i(){console.log("success")}function o(e,t){console.log("not so lucky: "+t)}function s(){a(),u.query=l,u.limit="0,100",u.withCount=!0,d=e.get("/js",u,i,o)}function r(e){l=e,n(),setTimeout(s,50)}var l,d=null,c=null,u={query:"",limit:"",withCount:!1};return t(),{sendQuery:r}}e.extend(!0,window,{nfsdb:{GridController:t}})}(jQuery),$(document).ready(function(){function e(){var e=$("body");!e.hasClass("mini-navbar")||e.hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):e.hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small"),$("#side-menu").metisMenu(),$(".collapse-link").click(function(){var e=$(this).closest("div.ibox"),t=$(this).find("i"),a=e.find("div.ibox-content");a.slideToggle(200),t.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),e.toggleClass("").toggleClass("border-bottom"),setTimeout(function(){e.resize(),e.find("[id^=map-]").resize()},50)}),$(".close-link").click(function(){var e=$(this).closest("div.ibox");e.remove()}),$(".fullscreen-link").click(function(){var e=$(this).closest("div.ibox"),t=$(this).find("i");$("body").toggleClass("fullscreen-ibox-mode"),t.toggleClass("fa-expand").toggleClass("fa-compress"),e.toggleClass("fullscreen"),setTimeout(function(){$(window).trigger("resize")},100)}),$(".close-canvas-menu").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".right-sidebar-toggle").click(function(){$("#right-sidebar").toggleClass("sidebar-open")}),$(".open-small-chat").click(function(){$(this).children().toggleClass("fa-comments").toggleClass("fa-remove"),$(".small-chat-box").toggleClass("active")}),$(".check-link").click(function(){var e=$(this).find("i"),t=$(this).next("span");return e.toggleClass("fa-check-square").toggleClass("fa-square-o"),t.toggleClass("todo-completed"),!1}),$(".navbar-minimalize").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".tooltip-demo").tooltip({selector:"[data-toggle=tooltip]",container:"body"}),$(".modal").appendTo("body"),fixHeight(),$(window).scroll(function(){$(window).scrollTop()>0&&!$("body").hasClass("fixed-nav")?$("#right-sidebar").addClass("sidebar-top"):$("#right-sidebar").removeClass("sidebar-top")}),$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fixHeight()}),$("[data-toggle=popover]").popover(),$("[data-toggle=tooltip]").tooltip()}),$(window).bind("resize",function(){$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")}),$(document).ready(function(){if(localStorageSupport){var e=localStorage.getItem("collapse_menu"),t=localStorage.getItem("fixedsidebar"),a=localStorage.getItem("fixednavbar"),n=localStorage.getItem("boxedlayout"),i=localStorage.getItem("fixedfooter"),o=$("body");"on"===t&&o.addClass("fixed-sidebar"),"on"===e&&(o.hasClass("fixed-sidebar")?o.hasClass("body-small")||o.addClass("mini-navbar"):o.hasClass("body-small")||o.addClass("mini-navbar")),"on"===a&&($(".navbar-static-top").removeClass("navbar-static-top").addClass("navbar-fixed-top"),o.addClass("fixed-nav")),"on"===n&&o.addClass("boxed-layout"),"on"===i&&$(".footer").addClass("fixed")}}),$(document).ready(function(){var e=$(".sql-editor"),t=$(".file-upload");$("a#sql-editor").click(function(){e.css("display","block"),t.css("display","none"),$("#sqlEditor").css("height","240px")}),$("a#file-upload").click(function(){e.css("display","none"),t.css("display","block")});var a=ace.edit("sqlEditor");a.getSession().setMode("ace/mode/sql"),a.setTheme("ace/theme/merbivore_soft"),a.setShowPrintMargin(!1),a.setDisplayIndentGuides(!1),a.setHighlightActiveLine(!1),"undefined"!=typeof Storage&&localStorage.getItem("lastQuery")&&a.setValue(localStorage.getItem("lastQuery")),a.focus();var n=$("#grid");n.css("height","430px")});