"use strict";function s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function toSize(e){return 1024>e?e:1048576>e?Math.round(e/1024)+"KB":1073741824>e?Math.round(e/1024/1024)+"MB":Math.round(e/1024/1024/1024)+"GB"}function nopropagation(e){e.stopPropagation(),e.preventDefault&&e.preventDefault()}function localStorageSupport(){return"localStorage"in window&&null!==window.localStorage}function fixHeight(){var e=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",e+"px");var t=$("nav.navbar-default").height(),n=$("#page-wrapper"),a=n.height();t>a&&n.css("min-height",t+"px"),a>t&&n.css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(t>a?n.css("min-height",t-60+"px"):n.css("min-height",$(window).height()-60+"px"))}!function(e){e.fn.grid=function(){function t(){p=e('<div class="qg-header-row"></div>'),p.appendTo(g),u=e('<div class="qg-canvas"></div>'),u.appendTo(g),u.bind("scroll",function(){p.scrollLeft(u.scrollLeft())})}function n(){c=e('<style type="text/css" rel="stylesheet"/>').appendTo(e("head"));for(var t=[],n=0,a=0;a<m.length;a++){var r=Math.max(f.minColumnWidth,8*m[a]+8);t.push(".qg-w"+a+"{width:"+r+"px;}"),n+=r}t.push(".qg-r{width:"+n+"px;}"),c[0].styleSheet?c[0].styleSheet.cssText=t.join(" "):c[0].appendChild(document.createTextNode(t.join(" ")))}function a(t){m=[];var n,a;for(n=0;n<t.columns.length;n++){var r=t.columns[n];e('<div class="qg-header qg-w'+n+'">'+r.name+"</div>").appendTo(p),m.push(0)}for(n=0;n<t.result.length;n++){var o=t.result[n],i=e('<div class="qg-r"></div>');for(a=0;a<o.length;a++){var s=o[a],d=null!==s?s.toString():"null";m[a]=Math.max(d.length,m[a]),e('<div class="qg-c qg-w'+a+'">'+d+"</div>").appendTo(i)}i.appendTo(u)}}function r(){c&&c.remove(),p.empty(),u.empty()}function o(){var e=u[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t-=90,u[0].style.height=t+"px"}function i(){var e=g[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t-=90,g[0].style.height=t+"px"}function s(){o(),i()}function d(e,t){r(),a(t.r),n(),s()}function l(){e(document).on("query.ok",d),e(window).resize(s)}var c,u,p,m,f={minColumnWidth:60},g=e(this);l(),t(),s()}}(jQuery),$(document).ready(function(){$("#grid").grid()}),function(e){e.fn.importManager=function(){function t(t){if(t.lengthComputable){var n=t.loaded||t.position;e("#"+M.id).find(" > .ud-progress").css("width",100*n/M.size+"%")}}function n(){var t=!1,n=!1;for(var a in T)if(T.hasOwnProperty(a)){var r=T[a];if(r.selected&&(t=!0,r.retry)){n=!0;break}}e("#btnImportClearSelected").attr("disabled",!t),e("#btnRetry").attr("disabled",!n)}function a(t,a){a.retry=2,e("#"+a.id+" > .ud-c1").html(a.name+'<span class="label label-danger m-l-lg">overwrite</span>'),n()}function r(t,a){a.retry=1,e("#"+a.id+" > .ud-c1").html(a.name+'<span class="label label-primary m-l-lg">append</span>'),n()}function o(t,a){a.retry=0,e("#"+a.id+" > .ud-c1").html(a.name),n()}function i(){var n=e.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",t,!1),n}function s(){e("#btnImportCancel").attr("disabled",null===M)}function d(){var t=e(this).parent().attr("id"),a=e("#"+t).find(".fa"),r=T[t];r.selected=!r.selected,r.selected?a.removeClass("fa-square-o").addClass("fa-check-square-o"):a.removeClass("fa-check-square-o").addClass("fa-square-o"),n()}function l(t){var n=T[e(this).parent().attr("id")];n.importState>-1&&e(document).trigger("import.detail",n),nopropagation(t)}function c(t){$.append('<div id="'+t.id+'" class="ud-row" style="top: '+j+'px;"><div class="ud-cell ud-c0"><i class="fa fa-square-o ud-checkbox"></i></div><div class="ud-cell ud-c1">'+t.name+'</div><div class="ud-cell ud-c2">'+t.sizeFmt+'</div><div class="ud-cell ud-c3"><span class="label">pending</span></div></div>');var n=e("#"+t.id);n.find(".ud-c0").click(d),n.find(".ud-c1").click(l),n.find(".ud-c2").click(l),n.find(".ud-c3").click(l),j+=O}function u(t,n,a){var r=e("#"+t.id);if(r.find(" > .ud-c3").html(n),r.find(" > .ud-progress").remove(),a){var o=I.shift();o?y(o):(M=null,z=null)}s(),e(document).trigger("import.detail.updated",t)}function p(e){"OK"===e.status?(M.response=e,M.importState=0,o(null,M),u(M,'<span class="label label-success">imported</span>',!0)):(M.importState=4,M.response=e.status,u(M,'<span class="label label-danger">failed</span>',!0))}function m(e){switch(e){case 0:return 3;case 500:return 5;default:return 101}}function f(e){o(null,M),"abort"!==e.statusText?(M.response=e.responseText,M.importState=m(e.status),u(M,'<span class="label label-danger">failed</span>',!0)):u(M,'<span class="label label-warning">aborted</span>',!0)}function g(){if(E.url="/imp?fmt=json",2===M.retry&&(E.url+="&o=true"),E.xhr=i,E.data=new FormData,M.response&&M.response.columns){for(var e="",t=0;t<M.response.columns.length;t++){var n=M.response.columns[t];n.altType&&n.type!==n.altType&&(e+=n.name+"="+n.altType+"&")}E.data.append("schema",e)}return E.data.append("data",M.file),E}function h(){u(M,'<span class="label label-info">importing</span>',!1),e("#"+M.id).append('<div class="ud-progress"></div>'),z=e.ajax(g()).done(p).fail(f),s()}function v(e){switch(e.status){case"EXISTS":M.importState=1,u(M,'<span class="label label-danger">exists</span>',!0);break;case"DOES_NOT_EXIST":M.importState=0,h();break;case"EXISTS_FOREIGN":M.importState=2,u(M,'<span class="label label-danger">reserved</span>',!0);break;default:M.importState=101,u(M,'<span class="label label-danger">failed</span>',!0)}}function y(t){M=t,t.retry?(M.importState=0,h()):(D.url="/chk?f=json&j="+t.name,e.ajax(D).then(v).fail(f))}function b(e,t){for(var n=0;n<t.files.length;n++){var a=t.files[n],r={id:guid(),name:a.name,size:a.size,file:a,sizeFmt:toSize(a.size),selected:!1,imported:!1};T[r.id]=r,c(r),null!=M?I.push(r):y(r)}}function w(){for(var t in T)if(T.hasOwnProperty(t)){var a=T[t];if(a.selected&&a!==M){var r=I.indexOf(a);r>-1&&delete I[r],e("#"+t).remove(),delete T[t],e(document).trigger("import.cleared",a)}}j=0;for(var o=$.find(".ud-row"),i=0;i<o.length;i++)e(o[i]).css("top",j),j+=O;n()}function x(){for(var e in T)if(T.hasOwnProperty(e)){var t=T[e];t.selected&&t.retry&&(null===M?y(t):I.push(t))}}function C(){null!==z&&z.abort()}function q(){e(document).on("dropbox.files",b),e(document).on("import.clearSelected",w),e(document).on("import.cancel",C),e(document).on("import.retry",x),e(document).on("import.line.overwrite",a),e(document).on("import.line.append",r),e(document).on("import.line.abort",o)}function S(){k.append('<div class="ud-header-row"><div class="ud-header ud-h0">&nbsp;</div><div class="ud-header ud-h1">File name</div><div class="ud-header ud-h2">Size</div><div class="ud-header ud-h3">Status</div></div>'),k.append('<div class="ud-canvas"></div>'),$=k.find("> .ud-canvas"),q()}var $,T={},k=this,j=0,I=[],M=null,O=35,z=null,E={xhr:i,url:"/imp?fmt=json",type:"POST",contentType:!1,processData:!1,cache:!1},D={type:"GET",contentType:!1,processData:!1,cache:!1};return S(),this},e.fn.dropbox=function(){function t(){o.addClass("drag-drop").removeClass("drag-idle")}function n(){o.removeClass("drag-drop").addClass("drag-idle")}function a(){o.on("drop",function(t){n(),r=e(),e(document).trigger("dropbox.files",t.originalEvent.dataTransfer)}),o.each(function(){var a=e(this);a.on("dragenter",function(e){0===r.size()&&(nopropagation(e),t()),r=r.add(e.target)}),a.on("dragleave",function(e){setTimeout(function(){r=r.not(e.target),0===r.size()&&n()},1)})})}var r=e(),o=this;return a(),this}}(jQuery),$(document).ready(function(){$("#btnImportClearSelected").click(function(){$(document).trigger("import.clearSelected")}),$("#btnImportCancel").click(function(){$(document).trigger("import.cancel")}),$("#btnRetry").click(function(){$(document).trigger("import.retry")}),$("#dragTarget").dropbox(),$("#import-file-list").importManager(),$(document).on("dragenter",nopropagation),$(document).on("dragover",nopropagation),$(document).on("drop",nopropagation),$(document).ready(function(){$("input").iCheck({checkboxClass:"icheckbox_square-red",radioClass:"iradio_square-red"})})}),function(e){e.fn.importEditor=function(){function t(){var e=x[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t=t-C-45,x[0].style.height=t+"px"}function n(){var t=e(this);c.appendTo(t.parent()),c.css("left",t.css("left")),c.css("width",t.css("width"));var n=parseInt(e(this).parent().find(".js-g-row").text())-1,a=k.response.columns[n];a.altType?c.val(a.altType):c.val(a.type),c.changeTargetDiv=t,c.changeTargetCol=a,c.show(),c.focus()}function a(){c.hide()}function r(e){return e.altType&&e.altType!==e.type?e.type+'<i class="fa fa-angle-double-right g-type-separator"></i>'+e.altType:e.type}function o(){for(var t=!1,n=0;n<k.response.columns.length;n++){var a=k.response.columns[n];if(a.altType&&a.type!==a.altType){t=!0;break}}e(document).trigger(t?"import.line.overwrite":"import.line.cancel",k)}function i(){c.changeTargetCol.altType=e(this).find("option:selected").text(),c.changeTargetDiv.html(r(c.changeTargetCol)),o(),a()}function s(){e(".g-type").click(n),e(".g-other").click(a),c.change(i)}function d(e){if(0!==e.importState||e.response){if(e.response&&0===e.importState){h.html(e.response.location);var n=e.response.rowsImported,a=e.response.rowsRejected,o=n+a;if(v.css("width",Math.round(100*a/o)+"%"),y.css("width",Math.round(100*n/o)+"%"),b.html(a),w.html(n),x.empty(),e.response.columns)for(var i=0,d=0;d<e.response.columns.length;d++){var l=e.response.columns[d];x.append('<div class="ud-row" style="top: '+i+'px"><div class="ud-cell gc-1 g-other js-g-row">'+(d+1)+'</div><div class="ud-cell gc-2 g-other">'+(l.errors>0?'<i class="fa fa-exclamation-triangle g-warning"></i>':"")+l.name+'</div><div class="ud-cell gc-3 g-type">'+r(l)+'</div><div class="ud-cell gc-4 g-other">'+l.errors+"</div></div>"),i+=$}s(),m.show(),f.hide(),t()}else{switch(e.importState){case 1:g.html("Journal <strong>"+e.name+"</strong> already exists on server"),q.show();break;case 2:g.html("Journal name <strong>"+e.name+"</strong> is reserved"),q.hide();break;case 3:g.html("Server is not responding..."),q.hide();break;case 4:g.html(e.response),q.hide();break;case 5:g.html("Server encountered internal problem. Check server logs for more details."),q.hide();break;default:g.html("Unknown error: "+e.responseStatus),q.hide()}m.hide(),f.show(),S.iCheck("uncheck")}u.show()}}function l(){c=e('<select class="g-dynamic-select form-control m-b"/>');for(var t=0;t<T.length;t++){var n=T[t];e("<option />",{value:n,text:n}).appendTo(c)}}var c,u=e(this),p=e(".stats-switcher"),m=e(this).find(".js-import-editor"),f=e(this).find(".js-import-error"),g=e(this).find(".js-message"),h=e(this).find(".js-import-tab-name"),v=e(this).find(".import-rejected"),y=e(this).find(".import-imported"),b=e(this).find(".js-rejected-row-count"),w=e(this).find(".js-imported-row-count"),x=e(this).find(".ud-canvas"),C=e(".footer")[0].offsetHeight,q=e(this).find(".js-import-error-btn-group"),S=e('input:radio[name="importAction"]'),$=35,T=["BOOLEAN","BYTE","DOUBLE","FLOAT","INT","LONG","SHORT","STRING","SYMBOL","DATE"],k=null;e(document).on("import.detail",function(e,t){k=t,d(t)}),e(document).on("import.detail.updated",function(e,t){k===t&&t.response&&d(t)}),e(document).on("import.cleared",function(e,t){t===k&&(k=null,m.hide(),f.hide())}),l(),e(".import-stats-chart").click(function(){p.hasClass("stats-visible")?p.removeClass("stats-visible"):p.addClass("stats-visible")}),S.on("ifClicked",function(){var t;switch(this.value){case"append":t="import.line.append";break;case"overwrite":t="import.line.overwrite";break;default:t="import.line.abort"}e(document).trigger(t,k)}),e(window).resize(t)}}(jQuery),$(document).ready(function(){$("#import-detail").importEditor()}),function(e){function t(){function t(){null!==c&&(c.abort(),c=null)}function n(){null!==u&&(clearTimeout(u),u=null)}function a(t){e(document).trigger("query.ok",{r:t,delta:(new Date).getTime()-l})}function r(t){e(document).trigger("query.error",{query:d,r:t.responseJSON,status:t.status,delta:(new Date).getTime()-l})}function o(){t(),p.query=d.q,p.limit="0,100",p.withCount=!1,l=(new Date).getTime(),c=e.get("/js",p).done(a).fail(r)}function i(e){d=e,n(),setTimeout(o,50)}function s(){e(document).on("query.execute",function(e,t){i(t)})}var d,l,c=null,u=null,p={query:"",limit:"",withCount:!1};s()}function n(){function t(){d.addClass("query-progress-animated",100),l.addClass("query-message-ok"),c.html("-"),u.html("Running...")}function n(){s=setTimeout(t,500)}function a(e,t){for(var n=0,a=0,r=Math.min(t,e.q.length),o=0;r>o;o++)"\n"===e.q.charAt(o)?(n++,a=0):a++;return{r:n+1+e.r,c:(0===n?a+e.c:a)+1}}function r(t,n){if(clearTimeout(s),d.removeClass("query-progress-animated"),l.removeClass("query-message-ok").addClass("query-message-error"),c.html("failed after <strong>"+n.delta/1e3+"s</strong>"),n.r){var r=a(n.query,n.r.position);u.html("<strong>"+r.r+":"+r.c+"</strong>&nbsp;&nbsp;"+n.r.error),e(document).trigger("editor.show.error",r)}else 0===n.status?u.html("Server down?"):u.html("Server error: "+n.status)}function o(e,t){clearTimeout(s),d.removeClass("query-progress-animated"),l.removeClass("query-message-error").addClass("query-message-ok"),c.html("read in <strong>"+t.delta/1e3+"s</strong>"),u.html("OK")}function i(){e(document).on("query.execute",n),e(document).on("query.error",r),e(document).on("query.ok",o)}var s,d=e(".js-query-spinner"),l=e(".js-query-message-panel"),c=e(".js-query-message-panel .js-query-time"),u=e(".js-query-message-panel .js-query-message-text");i()}function a(){function t(){l&&(d.session.removeMarker(l),l=null)}function n(){d=ace.edit("sqlEditor"),d.getSession().setMode("ace/mode/sql"),d.setTheme("ace/theme/merbivore_soft"),d.setShowPrintMargin(!1),d.setDisplayIndentGuides(!1),d.setHighlightActiveLine(!1),d.session.on("change",t),d.$blockScrolling=1/0}function a(){if("undefined"!=typeof Storage){var e=localStorage.getItem(c);e&&d.setValue(e)}}function r(){"undefined"!=typeof Storage&&localStorage.setItem(c,d.getValue())}function o(){r(),t();var n,a,o=d.getSelectedText();if(null==o||""===o)o=d.getValue(),n=0,a=0;else{var i=d.getSelectionRange();n=i.start.row,a=i.start.column}e(document).trigger("query.execute",{q:o,r:n,c:a})}function i(e,t){var n=d.session.getTokenAt(t.r-1,t.c);l=d.session.addMarker(new u(t.r-1,t.c-1,t.r-1,t.c+n.value.length-1),"js-syntax-error","text",!0),d.gotoLine(t.r,t.c-1),d.focus()}function s(){e(document).on("editor.execute",o),e(document).on("editor.show.error",i),d.commands.addCommand({name:"editor.execute",bindKey:"F9",exec:o})}var d,l,c="query.text",u=ace.require("ace/range").Range;n(),a(),s()}e.extend(!0,window,{qdb:{query:t,spinner:n,editor:a}})}(jQuery),$(document).ready(function(){qdb.query(),qdb.spinner(),qdb.editor(),$(".js-query-run").click(function(){$(document).trigger("editor.execute")})}),$(document).ready(function(){function e(){var e=$("body");!e.hasClass("mini-navbar")||e.hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):e.hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small"),$("#side-menu").metisMenu(),$(".navbar-minimalize").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".modal").appendTo("body"),fixHeight(),$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fixHeight()})}),$(window).bind("resize",function(){$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")}),$(document).ready(function(){if(localStorageSupport){var e=localStorage.getItem("collapse_menu"),t=localStorage.getItem("fixednavbar"),n=localStorage.getItem("boxedlayout"),a=localStorage.getItem("fixedfooter"),r=$("body");"on"===e&&(r.hasClass("fixed-sidebar")?r.hasClass("body-small")||r.addClass("mini-navbar"):r.hasClass("body-small")||r.addClass("mini-navbar")),"on"===t&&($(".navbar-static-top").removeClass("navbar-static-top").addClass("navbar-fixed-top"),r.addClass("fixed-nav")),"on"===n&&r.addClass("boxed-layout"),"on"===a&&$(".footer").addClass("fixed")}}),$(document).ready(function(){var e=$(".js-sql-panel"),t=$(".js-import-panel");$("a#sql-editor").click(function(){e.show(),t.hide(),$("#sqlEditor").css("height","240px")}),$("a#file-upload").click(function(){e.hide(),t.show()});var n=$("#grid");n.css("height","430px")});