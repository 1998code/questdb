/*******************************************************************************
 *    ___                  _   ____  ____
 *   / _ \ _   _  ___  ___| |_|  _ \| __ )
 *  | | | | | | |/ _ \/ __| __| | | |  _ \
 *  | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *   \__\_\\__,_|\___||___/\__|____/|____/
 *
 * Copyright (C) 2014-2016 Appsicle
 *
 * This program is free software: you can redistribute it and/or  modify
 * it under the terms of the GNU Affero General Public License, version 3,
 * as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * As a special exception, the copyright holders give permission to link the
 * code of portions of this program with the OpenSSL library under certain
 * conditions as described in each individual source file and distribute
 * linked combinations including the program with the OpenSSL library. You
 * must comply with the GNU Affero General Public License in all respects for
 * all of the code used other than as permitted herein. If you modify file(s)
 * with this exception, you may extend this exception to your version of the
 * file(s), but you are not obligated to do so. If you do not wish to do so,
 * delete this exception statement from your version. If you delete this
 * exception statement from all source files in the program, then also delete
 * it in the license file.
 *
 ******************************************************************************/

"use strict";function s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function toSize(e){return 1024>e?e:1048576>e?Math.round(e/1024)+"KB":1073741824>e?Math.round(e/1024/1024)+"MB":Math.round(e/1024/1024/1024)+"GB"}function nopropagation(e){e.stopPropagation(),e.preventDefault&&e.preventDefault()}function localStorageSupport(){return"localStorage"in window&&null!==window.localStorage}function fixHeight(){var e=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",e+"px");var t=$("nav.navbar-default").height(),n=$("#page-wrapper"),a=n.height();t>a&&n.css("min-height",t+"px"),a>t&&n.css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(t>a?n.css("min-height",t-60+"px"):n.css("min-height",$(window).height()-60+"px"))}!function(e){e.fn.grid=function(){function t(t){c=e('<style type="text/css" rel="stylesheet"/>').appendTo(e("head"));for(var n=[],a=8,r=0,o=0;o<t.length;o++){var s=t[o],i=s.name.length*a,d=0;switch(s.type){case"BOOLEAN":case"BYTE":d=30;break;case"DOUBLE":case"FLOAT":case"LONG":case"DATE":d=150;break;case"INT":case"SHORT":d=100;break;case"STRING":case"SYMBOL":d=0}var l=Math.max(i,d);n.push(".qg-w"+o+"{width:"+l+"px;}"),r+=l}n.push(".qg-r{width:"+r+"px;}"),c[0].styleSheet?c[0].styleSheet.cssText=n.join(" "):c[0].appendChild(document.createTextNode(n.join(" ")))}function n(){p=e('<div class="qg-header-row"></div>'),p.appendTo(m),u=e('<div class="qg-canvas"></div>'),u.appendTo(m),u.bind("scroll",function(){p.scrollLeft(u.scrollLeft())})}function a(t){var n,a;for(n=0;n<t.columns.length;n++){var r=t.columns[n];e('<div class="qg-header qg-w'+n+'">'+r.name+"</div>").appendTo(p)}for(n=0;n<t.result.length;n++){var o=t.result[n],s=e('<div class="qg-r"></div>');for(a=0;a<o.length;a++)e('<div class="qg-c qg-w'+a+'">'+o[a]+"</div>").appendTo(s);s.appendTo(u)}}function r(){c&&c.remove(),p.empty(),u.empty()}function o(){var e=u[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t-=90,u[0].style.height=t+"px"}function s(){var e=m[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t-=90,m[0].style.height=t+"px"}function i(){o(),s()}function d(e,n){r(),t(n.r.columns),a(n.r),i()}function l(){e(document).on("query.ok",d),e(window).resize(i)}var c,u,p,m=e(this);l(),n(),i()}}(jQuery),$(document).ready(function(){$("#grid").grid()}),function(e){e.fn.importManager=function(){function t(t){if(t.lengthComputable){var n=t.loaded||t.position;e("#"+I.id).find(" > .ud-progress").css("width",100*n/I.size+"%")}}function n(){var t=!1,n=!1;for(var a in $)if($.hasOwnProperty(a)){var r=$[a];if(r.selected&&(t=!0,r.retry)){n=!0;break}}e("#btnImportClearSelected").attr("disabled",!t),e("#btnRetry").attr("disabled",!n)}function a(t,a){a.retry=2,e("#"+a.id+" > .ud-c1").html(a.name+'<span class="label label-danger m-l-lg">overwrite</span>'),n()}function r(t,a){a.retry=1,e("#"+a.id+" > .ud-c1").html(a.name+'<span class="label label-primary m-l-lg">append</span>'),n()}function o(t,a){a.retry=0,e("#"+a.id+" > .ud-c1").html(a.name),n()}function s(){var n=e.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",t,!1),n}function i(){e("#btnImportCancel").attr("disabled",null===I)}function d(){var t=e(this).parent().attr("id"),a=e("#"+t).find(".fa"),r=$[t];r.selected=!r.selected,r.selected?a.removeClass("fa-square-o").addClass("fa-check-square-o"):a.removeClass("fa-check-square-o").addClass("fa-square-o"),n()}function l(t){var n=$[e(this).parent().attr("id")];n.importState>-1&&e(document).trigger("import.detail",n),nopropagation(t)}function c(t){q.append('<div id="'+t.id+'" class="ud-row" style="top: '+j+'px;"><div class="ud-cell ud-c0"><i class="fa fa-square-o ud-checkbox"></i></div><div class="ud-cell ud-c1">'+t.name+'</div><div class="ud-cell ud-c2">'+t.sizeFmt+'</div><div class="ud-cell ud-c3"><span class="label">pending</span></div></div>');var n=e("#"+t.id);n.find(".ud-c0").click(d),n.find(".ud-c1").click(l),n.find(".ud-c2").click(l),n.find(".ud-c3").click(l),j+=M}function u(t,n,a){var r=e("#"+t.id);if(r.find(" > .ud-c3").html(n),r.find(" > .ud-progress").remove(),a){var o=O.shift();o?y(o):(I=null,E=null)}i(),e(document).trigger("import.detail.updated",t)}function p(e){"OK"===e.status?(I.response=e,I.importState=0,o(null,I),u(I,'<span class="label label-success">imported</span>',!0)):(I.importState=4,I.response=e.status,u(I,'<span class="label label-danger">failed</span>',!0))}function m(e){switch(e){case 0:return 3;case 500:return 5;default:return 101}}function f(e){o(null,I),"abort"!==e.statusText?(I.response=e.responseText,I.importState=m(e.status),u(I,'<span class="label label-danger">failed</span>',!0)):u(I,'<span class="label label-warning">aborted</span>',!0)}function g(){if(z.url="/imp?fmt=json",2===I.retry&&(z.url+="&o=true"),z.xhr=s,z.data=new FormData,I.response&&I.response.columns){for(var e="",t=0;t<I.response.columns.length;t++){var n=I.response.columns[t];n.altType&&n.type!==n.altType&&(e+=n.name+"="+n.altType+"&")}z.data.append("schema",e)}return z.data.append("data",I.file),z}function h(){u(I,'<span class="label label-info">importing</span>',!1),e("#"+I.id).append('<div class="ud-progress"></div>'),E=e.ajax(g()).done(p).fail(f),i()}function v(e){switch(e.status){case"EXISTS":I.importState=1,u(I,'<span class="label label-danger">exists</span>',!0);break;case"DOES_NOT_EXIST":I.importState=0,h();break;case"EXISTS_FOREIGN":I.importState=2,u(I,'<span class="label label-danger">reserved</span>',!0);break;default:I.importState=101,u(I,'<span class="label label-danger">failed</span>',!0)}}function y(t){I=t,t.retry?(I.importState=0,h()):(D.url="/chk?f=json&j="+t.name,e.ajax(D).then(v).fail(f))}function b(e,t){for(var n=0;n<t.files.length;n++){var a=t.files[n],r={id:guid(),name:a.name,size:a.size,file:a,sizeFmt:toSize(a.size),selected:!1,imported:!1};$[r.id]=r,c(r),null!=I?O.push(r):y(r)}}function w(){for(var t in $)if($.hasOwnProperty(t)){var a=$[t];if(a.selected&&a!==I){var r=O.indexOf(a);r>-1&&delete O[r],e("#"+t).remove(),delete $[t],e(document).trigger("import.cleared",a)}}j=0;for(var o=q.find(".ud-row"),s=0;s<o.length;s++)e(o[s]).css("top",j),j+=M;n()}function x(){for(var e in $)if($.hasOwnProperty(e)){var t=$[e];t.selected&&t.retry&&(null===I?y(t):O.push(t))}}function T(){null!==E&&E.abort()}function C(){e(document).on("dropbox.files",b),e(document).on("import.clearSelected",w),e(document).on("import.cancel",T),e(document).on("import.retry",x),e(document).on("import.line.overwrite",a),e(document).on("import.line.append",r),e(document).on("import.line.abort",o)}function S(){k.append('<div class="ud-header-row"><div class="ud-header ud-h0">&nbsp;</div><div class="ud-header ud-h1">File name</div><div class="ud-header ud-h2">Size</div><div class="ud-header ud-h3">Status</div></div>'),k.append('<div class="ud-canvas"></div>'),q=k.find("> .ud-canvas"),C()}var q,$={},k=this,j=0,O=[],I=null,M=35,E=null,z={xhr:s,url:"/imp?fmt=json",type:"POST",contentType:!1,processData:!1,cache:!1},D={type:"GET",contentType:!1,processData:!1,cache:!1};return S(),this},e.fn.dropbox=function(){function t(){o.addClass("drag-drop").removeClass("drag-idle")}function n(){o.removeClass("drag-drop").addClass("drag-idle")}function a(){o.on("drop",function(t){n(),r=e(),e(document).trigger("dropbox.files",t.originalEvent.dataTransfer)}),o.each(function(){var a=e(this);a.on("dragenter",function(e){0===r.size()&&(nopropagation(e),t()),r=r.add(e.target)}),a.on("dragleave",function(e){setTimeout(function(){r=r.not(e.target),0===r.size()&&n()},1)})})}var r=e(),o=this;return a(),this}}(jQuery),$(document).ready(function(){$("#btnImportClearSelected").click(function(){$(document).trigger("import.clearSelected")}),$("#btnImportCancel").click(function(){$(document).trigger("import.cancel")}),$("#btnRetry").click(function(){$(document).trigger("import.retry")}),$("#dragTarget").dropbox(),$("#import-file-list").importManager(),$(document).on("dragenter",nopropagation),$(document).on("dragover",nopropagation),$(document).on("drop",nopropagation),$(document).ready(function(){$("input").iCheck({checkboxClass:"icheckbox_square-red",radioClass:"iradio_square-red"})})}),function(e){e.fn.importEditor=function(){function t(){var e=x[0].getBoundingClientRect().top,t=Math.round(window.innerHeight-e);t=t-T-45,x[0].style.height=t+"px"}function n(){var t=e(this);c.appendTo(t.parent()),c.css("left",t.css("left")),c.css("width",t.css("width"));var n=parseInt(e(this).parent().find(".js-g-row").text())-1,a=k.response.columns[n];a.altType?c.val(a.altType):c.val(a.type),c.changeTargetDiv=t,c.changeTargetCol=a,c.show(),c.focus()}function a(){c.hide()}function r(e){return e.altType&&e.altType!==e.type?e.type+'<i class="fa fa-angle-double-right g-type-separator"></i>'+e.altType:e.type}function o(){for(var t=!1,n=0;n<k.response.columns.length;n++){var a=k.response.columns[n];if(a.altType&&a.type!==a.altType){t=!0;break}}e(document).trigger(t?"import.line.overwrite":"import.line.cancel",k)}function s(){c.changeTargetCol.altType=e(this).find("option:selected").text(),c.changeTargetDiv.html(r(c.changeTargetCol)),o(),a()}function i(){e(".g-type").click(n),e(".g-other").click(a),c.change(s)}function d(e){if(0!==e.importState||e.response){if(e.response&&0===e.importState){h.html(e.response.location);var n=e.response.rowsImported,a=e.response.rowsRejected,o=n+a;if(v.css("width",Math.round(100*a/o)+"%"),y.css("width",Math.round(100*n/o)+"%"),b.html(a),w.html(n),x.empty(),e.response.columns)for(var s=0,d=0;d<e.response.columns.length;d++){var l=e.response.columns[d];x.append('<div class="ud-row" style="top: '+s+'px"><div class="ud-cell gc-1 g-other js-g-row">'+(d+1)+'</div><div class="ud-cell gc-2 g-other">'+(l.errors>0?'<i class="fa fa-exclamation-triangle g-warning"></i>':"")+l.name+'</div><div class="ud-cell gc-3 g-type">'+r(l)+'</div><div class="ud-cell gc-4 g-other">'+l.errors+"</div></div>"),s+=q}i(),m.show(),f.hide(),t()}else{switch(e.importState){case 1:g.html("Journal <strong>"+e.name+"</strong> already exists on server"),C.show();break;case 2:g.html("Journal name <strong>"+e.name+"</strong> is reserved"),C.hide();break;case 3:g.html("Server is not responding..."),C.hide();break;case 4:g.html(e.response),C.hide();break;case 5:g.html("Server encountered internal problem. Check server logs for more details."),C.hide();break;default:g.html("Unknown error: "+e.responseStatus),C.hide()}m.hide(),f.show(),S.iCheck("uncheck")}u.show()}}function l(){c=e('<select class="g-dynamic-select form-control m-b"/>');for(var t=0;t<$.length;t++){var n=$[t];e("<option />",{value:n,text:n}).appendTo(c)}}var c,u=e(this),p=e(".stats-switcher"),m=e(this).find(".js-import-editor"),f=e(this).find(".js-import-error"),g=e(this).find(".js-message"),h=e(this).find(".js-import-tab-name"),v=e(this).find(".import-rejected"),y=e(this).find(".import-imported"),b=e(this).find(".js-rejected-row-count"),w=e(this).find(".js-imported-row-count"),x=e(this).find(".ud-canvas"),T=e(".footer")[0].offsetHeight,C=e(this).find(".js-import-error-btn-group"),S=e('input:radio[name="importAction"]'),q=35,$=["BOOLEAN","BYTE","DOUBLE","FLOAT","INT","LONG","SHORT","STRING","SYMBOL","DATE"],k=null;e(document).on("import.detail",function(e,t){k=t,d(t)}),e(document).on("import.detail.updated",function(e,t){k===t&&t.response&&d(t)}),e(document).on("import.cleared",function(e,t){t===k&&(k=null,m.hide(),f.hide())}),l(),e(".import-stats-chart").click(function(){p.hasClass("stats-visible")?p.removeClass("stats-visible"):p.addClass("stats-visible")}),S.on("ifClicked",function(){var t;switch(this.value){case"append":t="import.line.append";break;case"overwrite":t="import.line.overwrite";break;default:t="import.line.abort"}e(document).trigger(t,k)}),e(window).resize(t)}}(jQuery),$(document).ready(function(){$("#import-detail").importEditor()}),function(e){function t(){function t(){null!==c&&(c.abort(),c=null)}function n(){null!==u&&(clearTimeout(u),u=null)}function a(t){e(document).trigger("query.ok",{r:t,delta:(new Date).getTime()-l})}function r(t){e(document).trigger("query.error",{query:d,r:t.responseJSON,status:t.status,delta:(new Date).getTime()-l})}function o(){t(),p.query=d.q,p.limit="0,100",p.withCount=!1,l=(new Date).getTime(),c=e.get("/js",p).done(a).fail(r)}function s(e){d=e,n(),setTimeout(o,50)}function i(){e(document).on("query.execute",function(e,t){s(t)})}var d,l,c=null,u=null,p={query:"",limit:"",withCount:!1};i()}function n(){function t(){d.addClass("query-progress-animated",100),l.addClass("query-message-ok"),c.html("-"),u.html("Running...")}function n(){i=setTimeout(t,500)}function a(e,t){for(var n=0,a=0,r=Math.min(t,e.q.length),o=0;r>o;o++)"\n"===e.q.charAt(o)?(n++,a=0):a++;return{r:n+1+e.r,c:(0===n?a+e.c:a)+1}}function r(t,n){if(clearTimeout(i),d.removeClass("query-progress-animated"),l.removeClass("query-message-ok").addClass("query-message-error"),c.html("failed after <strong>"+n.delta/1e3+"s</strong>"),n.r){var r=a(n.query,n.r.position);u.html("<strong>"+r.r+":"+r.c+"</strong>&nbsp;&nbsp;"+n.r.error),e(document).trigger("editor.show.error",r)}else 0===n.status?u.html("Server down?"):u.html("Server error: "+n.status)}function o(e,t){clearTimeout(i),d.removeClass("query-progress-animated"),l.removeClass("query-message-error").addClass("query-message-ok"),c.html("read in <strong>"+t.delta/1e3+"s</strong>"),u.html("OK")}function s(){e(document).on("query.execute",n),e(document).on("query.error",r),e(document).on("query.ok",o)}var i,d=e(".js-query-spinner"),l=e(".js-query-message-panel"),c=e(".js-query-message-panel .js-query-time"),u=e(".js-query-message-panel .js-query-message-text");s()}function a(){function t(){d&&(i.session.removeMarker(d),d=null)}function n(){i=ace.edit("sqlEditor"),i.getSession().setMode("ace/mode/sql"),i.setTheme("ace/theme/merbivore_soft"),i.setShowPrintMargin(!1),i.setDisplayIndentGuides(!1),i.setHighlightActiveLine(!1),i.session.on("change",t)}function a(){"undefined"!=typeof Storage&&localStorage.getItem(l)&&i.setValue(localStorage.getItem(l))}function r(){t();var n,a,r=i.getSelectedText();if(null==r||""===r)r=i.getValue(),n=0,a=0;else{var o=i.getSelectionRange();n=o.start.row,a=o.start.column}e(document).trigger("query.execute",{q:r,r:n,c:a})}function o(e,t){var n=i.session.getTokenAt(t.r-1,t.c);d=i.session.addMarker(new c(t.r-1,t.c-1,t.r-1,t.c+n.value.length-1),"js-syntax-error","text",!0),i.gotoLine(t.r,t.c-1),i.focus()}function s(){e(document).on("editor.execute",r),e(document).on("editor.show.error",o),i.commands.addCommand({name:"editor.execute",bindKey:"F9",exec:r})}var i,d,l="lastQuery",c=ace.require("ace/range").Range;n(),a(),s()}e.extend(!0,window,{qdb:{query:t,spinner:n,editor:a}})}(jQuery),$(document).ready(function(){qdb.query(),qdb.spinner(),qdb.editor(),$(".js-query-run").click(function(){$(document).trigger("editor.execute")})}),$(document).ready(function(){function e(){var e=$("body");!e.hasClass("mini-navbar")||e.hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):e.hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small"),$("#side-menu").metisMenu(),$(".navbar-minimalize").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".modal").appendTo("body"),fixHeight(),$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fixHeight()})}),$(window).bind("resize",function(){$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")}),$(document).ready(function(){if(localStorageSupport){var e=localStorage.getItem("collapse_menu"),t=localStorage.getItem("fixednavbar"),n=localStorage.getItem("boxedlayout"),a=localStorage.getItem("fixedfooter"),r=$("body");"on"===e&&(r.hasClass("fixed-sidebar")?r.hasClass("body-small")||r.addClass("mini-navbar"):r.hasClass("body-small")||r.addClass("mini-navbar")),"on"===t&&($(".navbar-static-top").removeClass("navbar-static-top").addClass("navbar-fixed-top"),r.addClass("fixed-nav")),"on"===n&&r.addClass("boxed-layout"),"on"===a&&$(".footer").addClass("fixed")}}),$(document).ready(function(){var e=$(".js-sql-panel"),t=$(".js-import-panel");$("a#sql-editor").click(function(){e.show(),t.hide(),$("#sqlEditor").css("height","240px")}),$("a#file-upload").click(function(){e.hide(),t.show()});var n=$("#grid");n.css("height","430px")});