/*******************************************************************************
 *  _  _ ___ ___     _ _
 * | \| | __/ __| __| | |__
 * | .` | _|\__ \/ _` | '_ \
 * |_|\_|_| |___/\__,_|_.__/
 *
 * Copyright (c) 2014-2016. The NFSdb project and its contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 ******************************************************************************/

"use strict";function s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function toSize(e){return 1024>e?e:1048576>e?Math.round(e/1024)+"KB":1073741824>e?Math.round(e/1024/1024)+"MB":Math.round(e/1024/1024/1024)+"GB"}function nopropagation(e){e.stopPropagation(),e.preventDefault&&e.preventDefault()}function localStorageSupport(){return"localStorage"in window&&null!==window.localStorage}function fixHeight(){var e=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",e+"px");var t=$("nav.navbar-default").height(),s=$("#page-wrapper"),i=s.height();t>i&&s.css("min-height",t+"px"),i>t&&s.css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(t>i?s.css("min-height",t-60+"px"):s.css("min-height",$(window).height()-60+"px"))}!function(e){e.fn.importManager=function(){function t(){var t=!1;for(var s in m)if(m.hasOwnProperty(s)&&m[s].selected){t=!0;break}e("#btnImportClearSelected").attr("disabled",!t)}function s(){e("#btnImportCancel").attr("disabled",null===y)}function i(){var s=e(this).parent().attr("id"),i=e("#"+s).find(".fa"),a=m[s];a.selected=!a.selected,a.selected?i.removeClass("fa-square-o").addClass("fa-check-square-o"):i.removeClass("fa-check-square-o").addClass("fa-square-o"),t()}function a(t){var s=m[e(this).parent().attr("id")];s.responseStatus&&e(document).trigger("import.detail",s),nopropagation(t)}function o(t){h.append('<div id="'+t.id+'" class="ud-row" style="top: '+b+'px;"><div class="ud-cell ud-c0"><i class="fa fa-square-o ud-checkbox"></i></div><div class="ud-cell ud-c1">'+t.name+'</div><div class="ud-cell ud-c2">'+t.sizeFmt+'</div><div class="ud-cell ud-c3"><span class="label">pending</span></div></div>');var s=e("#"+t.id);s.find(".ud-c0").click(i),s.find(".ud-c1").click(a),s.find(".ud-c2").click(a),s.find(".ud-c3").click(a),b+=C}function n(t){if(t.lengthComputable){var s=t.loaded||t.position;e("#"+y.id).find(" > .ud-progress").css("width",100*s/y.size+"%")}}function l(t,i,a){var o=e("#"+t.id);if(o.find(" > .ud-c3").html(i),o.find(" > .ud-progress").remove(),a){var n=$.shift();n?u(n):(y=null,w=null)}s()}function r(){var t=e.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",n,!1),t}function d(e){y.response=e,y.responseStatus=200,l(y,'<span class="label label-success">imported</span>',!0)}function c(e){y.response=e.responseText,y.responseStatus=e.status,"abort"!==e.statusText?l(y,'<span class="label label-danger">failed</span>',!0):l(y,'<span class="label label-warning">aborted</span>',!0)}function u(t){y=t,l(t,'<span class="label label-info">importing</span>',!1),e("#"+t.id).append('<div class="ud-progress"></div>'),x.data=new FormData,x.data.append("data",t.file),w=e.ajax(x),s()}function p(e,t){for(var s=0;s<t.files.length;s++){var i=t.files[s],a={id:guid(),name:i.name,size:i.size,file:i,sizeFmt:toSize(i.size),selected:!1,imported:!1};m[a.id]=a,o(a),null!=y?$.push(a):u(a)}}function f(){for(var s in m)if(m.hasOwnProperty(s)){var i=m[s];if(i.selected&&i!==y){var a=$.indexOf(i);a>-1&&delete $[a],e("#"+s).remove(),delete m[s],e(document).trigger("import.cleared",i)}}b=0;for(var o=h.find(".ud-row"),n=0;n<o.length;n++)e(o[n]).css("top",b),b+=C;t()}function g(){null!==w&&w.abort()}var h,m={},v=this,b=0,$=[],y=null,C=35,w=null,x={xhr:r,url:"/imp?fmt=json",type:"POST",contentType:!1,processData:!1,cache:!1,success:d,error:c};return v.append('<div class="ud-header-row"><div class="ud-header ud-h0">&nbsp;</div><div class="ud-header ud-h1">File name</div><div class="ud-header ud-h2">Size</div><div class="ud-header ud-h3">Status</div></div>'),v.append('<div class="ud-canvas"></div>'),h=v.find("> .ud-canvas"),e(document).on("dropbox.files",p),e(document).on("import.clearSelected",f),e(document).on("import.cancel",g),this},e.fn.dropbox=function(){function t(){o.addClass("drag-drop").removeClass("drag-idle")}function s(){o.removeClass("drag-drop").addClass("drag-idle")}function i(){o.on("drop",function(t){s(),a=e(),e(document).trigger("dropbox.files",t.originalEvent.dataTransfer)}),o.each(function(){var i=e(this);i.on("dragenter",function(e){0===a.size()&&(nopropagation(e),t()),a=a.add(e.target)}),i.on("dragleave",function(e){setTimeout(function(){a=a.not(e.target),0===a.size()&&s()},1)})})}var a=e(),o=this;return i(),this}}(jQuery),$(document).ready(function(){$("#btnImportClearSelected").click(function(){$(document).trigger("import.clearSelected")}),$("#btnImportCancel").click(function(){$(document).trigger("import.cancel")}),$("#btnRetry").click(function(){$(document).trigger("import.retry")}),$("#dragTarget").dropbox(),$("#import-file-list").importManager(),$(document).on("dragenter",nopropagation),$(document).on("dragover",nopropagation),$(document).on("drop",nopropagation)}),function(e){e.fn.importEditor=function(){function t(){var t=e(this);l.appendTo(t.parent()),l.css("left",t.css("left")),l.css("width",t.css("width"));var s=parseInt(e(this).parent().find(".js-g-row").text())-1,i=C.response.columns[s];i.altType?l.val(i.altType):l.val(i.type),l.changeTargetDiv=t,l.changeTargetCol=i,l.show(),l.focus()}function s(){l.hide()}function i(e){return e.altType&&e.altType!==e.type?e.type+'<i class="fa fa-angle-double-right g-type-separator"></i>'+e.altType:e.type}function a(){l.changeTargetCol.altType=e(this).find("option:selected").text(),l.changeTargetDiv.html(i(l.changeTargetCol)),s()}function o(){e(".g-type").click(t),e(".g-other").click(s),l.change(a)}function n(e){if(e.response&&200===e.responseStatus){f.html(e.response.location);var t=e.response.rowsImported,s=e.response.rowsRejected,a=t+s;if(g.css("width",Math.round(100*s/a)+"%"),h.css("width",Math.round(100*t/a)+"%"),m.html(s),v.html(t),b.empty(),e.response.columns)for(var n=0,l=0;l<e.response.columns.length;l++){var d=e.response.columns[l];b.append('<div class="ud-row" style="top: '+n+'px"><div class="ud-cell gc-1 g-other js-g-row">'+(l+1)+'</div><div class="ud-cell gc-2 g-other">'+(d.errors>0?'<i class="fa fa-exclamation-triangle g-warning"></i>':"")+d.name+'</div><div class="ud-cell gc-3 g-type">'+i(d)+'</div><div class="ud-cell gc-4 g-other">'+d.size+'</div><div class="ud-cell gc-5 g-other">'+d.errors+"</div></div>"),n+=$}o(),c.show(),u.hide()}else{switch(e.responseStatus){case 0:p.html("Server is not responding...");break;case 400:p.html("Server rejected file due to unsupported file format.");break;case 500:p.html("Server encountered internal problem. Check server logs for more details.");break;default:p.html("Unknown error: "+e.responseStatus)}c.hide(),u.show()}r.show()}var l,r=e(this),d=e(".stats-switcher"),c=e(this).find(".js-import-editor"),u=e(this).find(".js-import-error"),p=u.find("p"),f=e(this).find(".js-import-tab-name"),g=e(this).find(".import-rejected"),h=e(this).find(".import-imported"),m=e(this).find(".js-rejected-row-count"),v=e(this).find(".js-imported-row-count"),b=e(this).find(".ud-canvas"),$=35,y=["BOOLEAN","BYTE","DOUBLE","FLOAT","INT","LONG","SHORT","STRING","SYMBOL","DATE"],C=null;e(document).on("import.detail",function(e,t){C=t,n(t)}),e(document).on("import.cleared",function(e,t){t===C&&(C=null,c.hide())}),l=e('<select class="g-dynamic-select form-control m-b"/>');for(var w=0;w<y.length;w++){var x=y[w];e("<option />",{value:x,text:x}).appendTo(l)}e(".import-stats-chart").click(function(){d.hasClass("stats-visible")?d.removeClass("stats-visible"):d.addClass("stats-visible")})}}(jQuery),$(document).ready(function(){$("#import-detail").importEditor()}),function(e){function t(){function t(){}function s(){null!==d&&(d.abort(),d=null)}function i(){null!==c&&(clearTimeout(c),c=null)}function a(){console.log("success")}function o(e,t){console.log("not so lucky: "+t)}function n(){s(),u.query=r,u.limit="0,100",u.withCount=!0,d=e.get("/js",u,a,o)}function l(e){r=e,i(),setTimeout(n,50)}var r,d=null,c=null,u={query:"",limit:"",withCount:!1};return t(),{sendQuery:l}}e.extend(!0,window,{nfsdb:{GridController:t}})}(jQuery),$(document).ready(function(){function e(){var e=$("body");!e.hasClass("mini-navbar")||e.hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):e.hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small"),$("#side-menu").metisMenu(),$(".collapse-link").click(function(){var e=$(this).closest("div.ibox"),t=$(this).find("i"),s=e.find("div.ibox-content");s.slideToggle(200),t.toggleClass("fa-chevron-up").toggleClass("fa-chevron-down"),e.toggleClass("").toggleClass("border-bottom"),setTimeout(function(){e.resize(),e.find("[id^=map-]").resize()},50)}),$(".close-link").click(function(){var e=$(this).closest("div.ibox");e.remove()}),$(".fullscreen-link").click(function(){var e=$(this).closest("div.ibox"),t=$(this).find("i");$("body").toggleClass("fullscreen-ibox-mode"),t.toggleClass("fa-expand").toggleClass("fa-compress"),e.toggleClass("fullscreen"),setTimeout(function(){$(window).trigger("resize")},100)}),$(".close-canvas-menu").click(function(){$("body").toggleClass("mini-navbar"),e()}),$("body.canvas-menu .sidebar-collapse").slimScroll({height:"100%",railOpacity:.9}),$(".right-sidebar-toggle").click(function(){$("#right-sidebar").toggleClass("sidebar-open")}),$(".sidebar-container").slimScroll({height:"100%",railOpacity:.4,wheelStep:10}),$(".open-small-chat").click(function(){$(this).children().toggleClass("fa-comments").toggleClass("fa-remove"),$(".small-chat-box").toggleClass("active")}),$(".small-chat-box .content").slimScroll({height:"234px",railOpacity:.4}),$(".check-link").click(function(){var e=$(this).find("i"),t=$(this).next("span");return e.toggleClass("fa-check-square").toggleClass("fa-square-o"),t.toggleClass("todo-completed"),!1}),$(".navbar-minimalize").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".tooltip-demo").tooltip({selector:"[data-toggle=tooltip]",container:"body"}),$(".modal").appendTo("body"),fixHeight(),$(window).bind("load",function(){$("body").hasClass("fixed-sidebar")&&$(".sidebar-collapse").slimScroll({height:"100%",railOpacity:.9})}),$(window).scroll(function(){$(window).scrollTop()>0&&!$("body").hasClass("fixed-nav")?$("#right-sidebar").addClass("sidebar-top"):$("#right-sidebar").removeClass("sidebar-top")}),$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fixHeight()}),$("[data-toggle=popover]").popover(),$("[data-toggle=tooltip]").tooltip(),$(".full-height-scroll").slimscroll({height:"100%"})}),$(window).bind("resize",function(){$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")}),$(document).ready(function(){if(localStorageSupport){var e=localStorage.getItem("collapse_menu"),t=localStorage.getItem("fixedsidebar"),s=localStorage.getItem("fixednavbar"),i=localStorage.getItem("boxedlayout"),a=localStorage.getItem("fixedfooter"),o=$("body");"on"===t&&(o.addClass("fixed-sidebar"),$(".sidebar-collapse").slimScroll({height:"100%",railOpacity:.9})),"on"===e&&(o.hasClass("fixed-sidebar")?o.hasClass("body-small")||o.addClass("mini-navbar"):o.hasClass("body-small")||o.addClass("mini-navbar")),"on"===s&&($(".navbar-static-top").removeClass("navbar-static-top").addClass("navbar-fixed-top"),o.addClass("fixed-nav")),"on"===i&&o.addClass("boxed-layout"),"on"===a&&$(".footer").addClass("fixed")}}),$(document).ready(function(){var e=$(".sql-editor"),t=$(".file-upload");$("a#sql-editor").click(function(){e.css("display","block"),t.css("display","none"),$("#sqlEditor").css("height","240px")}),$("a#file-upload").click(function(){e.css("display","none"),t.css("display","block")});var s=ace.edit("sqlEditor");s.getSession().setMode("ace/mode/sql"),s.setTheme("ace/theme/merbivore_soft"),s.setShowPrintMargin(!1),s.setDisplayIndentGuides(!1),s.setHighlightActiveLine(!1),"undefined"!=typeof Storage&&localStorage.getItem("lastQuery")&&s.setValue(localStorage.getItem("lastQuery")),s.focus();var i=$("#grid");i.css("height","430px");var a=new Slick.Grid(i,[],[],{enableCellNavigation:!0,enableColumnReorder:!1,enableTextSelectionOnCells:!0});a.resizeCanvas()});