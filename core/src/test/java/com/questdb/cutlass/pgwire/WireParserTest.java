/*******************************************************************************
 *    ___                  _   ____  ____
 *   / _ \ _   _  ___  ___| |_|  _ \| __ )
 *  | | | | | | |/ _ \/ __| __| | | |  _ \
 *  | |_| | |_| |  __/\__ \ |_| |_| | |_) |
 *   \__\_\\__,_|\___||___/\__|____/|____/
 *
 * Copyright (C) 2014-2019 Appsicle
 *
 * This program is free software: you can redistribute it and/or  modify
 * it under the terms of the GNU Affero General Public License, version 3,
 * as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 ******************************************************************************/

package com.questdb.cutlass.pgwire;

import com.questdb.griffin.AbstractGriffinTest;
import com.questdb.griffin.engine.functions.rnd.SharedRandom;
import com.questdb.log.Log;
import com.questdb.log.LogFactory;
import com.questdb.network.*;
import com.questdb.std.Numbers;
import com.questdb.std.Rnd;
import com.questdb.std.Unsafe;
import com.questdb.std.str.CharSink;
import com.questdb.std.str.StringSink;
import com.questdb.test.tools.TestUtils;
import org.junit.Assert;
import org.junit.Test;
import org.postgresql.util.PSQLException;

import java.io.IOException;
import java.io.InputStream;
import java.sql.*;
import java.util.Properties;
import java.util.concurrent.BrokenBarrierException;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.CyclicBarrier;
import java.util.concurrent.atomic.AtomicBoolean;

import static com.questdb.std.Numbers.hexDigits;

public class WireParserTest extends AbstractGriffinTest {

    private static final Log LOG = LogFactory.getLog(WireParserTest.class);

    private static void toSink(InputStream is, CharSink sink) throws IOException {
        // limit what we print
        byte[] bb = new byte[1];
        int i = 0;
        while (is.read(bb) > 0) {
            byte b = bb[0];
            if (i > 0) {
                if ((i % 16) == 0) {
                    sink.put('\n');
                    Numbers.appendHexPadded(sink, i);
                }
            } else {
                Numbers.appendHexPadded(sink, i);
            }
            sink.put(' ');

            final int v;
            if (b < 0) {
                v = 256 + b;
            } else {
                v = b;
            }

            if (v < 0x10) {
                sink.put('0');
                sink.put(hexDigits[b]);
            } else {
                sink.put(hexDigits[v / 0x10]);
                sink.put(hexDigits[v % 0x10]);
            }

            i++;
        }
    }

    @Test
    public void testDDL() throws Exception {
        TestUtils.assertMemoryLeak(() -> {
            final CountDownLatch haltLatch = new CountDownLatch(1);
            final AtomicBoolean running = new AtomicBoolean(true);
            try {
                startBasicServer(
                        NetworkFacadeImpl.INSTANCE,
                        new DefaultWireParserConfiguration(),
                        haltLatch,
                        running
                );

                Properties properties = new Properties();
                properties.setProperty("user", "xyz");
                properties.setProperty("password", "oh");
                properties.setProperty("sslmode", "disable");

                final Connection connection = DriverManager.getConnection("jdbc:postgresql://127.0.0.1:9120/nabu_app", properties);
                PreparedStatement statement = connection.prepareStatement("create table x (a int)");
                statement.execute();
                connection.close();
            } finally {
                running.set(false);
                haltLatch.await();
            }
        });
    }

    @Test
    public void testHexFragmentedSend() throws Exception {
        final NetworkFacade nf = new NetworkFacadeImpl() {
            @Override
            public int send(long fd, long buffer, int bufferLen) {
                int total = 0;
                for (int i = 0; i < bufferLen; i++) {
                    int n = super.send(fd, buffer + i, 1);
                    if (n < 0) {
                        return n;
                    }
                    total += n;
                }
                return total;
            }
        };

        // this is a HEX encoded bytes of the same script as 'testSimple' sends using postgres jdbc driver
        String script = ">0000007300030000757365720078797a006461746162617365006e6162755f61707000636c69656e745f656e636f64696e67005554463800446174655374796c650049534f0054696d655a6f6e65004575726f70652f4c6f6e646f6e0065787472615f666c6f61745f64696769747300320000\n" +
                "<520000000800000003\n" +
                ">70000000076f6800\n" +
                "<520000000800000000530000001154696d655a6f6e6500474d5400530000001d6170706c69636174696f6e5f6e616d65005175657374444200530000001e7365727665725f76657273696f6e5f6e756d00313030303030005300000019696e74656765725f6461746574696d6573006f6e005a0000000549\n" +
                ">5000000022005345542065787472615f666c6f61745f646967697473203d2033000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">420000000c00000000000000004500000009000000000153000000044500000009000000000153000000045300000004500000003700534554206170706c69636174696f6e5f6e616d65203d2027506f737467726553514c204a4442432044726976657227000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">420000000c0000000000000000450000000900000000015300000004\n" +
                ">450000000900000000015300000004\n" +
                ">5300000004\n" +
                ">50000001a20073656c65637420726e645f73747228342c342c342920732c20726e645f696e7428302c203235362c20342920692c20726e645f646f75626c6528342920642c2074696d657374616d705f73657175656e636528746f5f74696d657374616d702830292c31303030302920742c20726e645f666c6f617428342920662c20726e645f73686f72742829205f73686f72742c20726e645f6c6f6e6728302c2031303030303030302c203529206c2c20726e645f74696d657374616d7028746f5f74696d657374616d70282732303135272c277979797927292c746f5f74696d657374616d70282732303136272c277979797927292c3229207473322c20726e645f6279746528302c313237292062622c20726e645f626f6f6c65616e282920622c20726e645f73796d626f6c28342c342c342c32292c20726e645f6461746528746f5f64617465282732303135272c20277979797927292c20746f5f64617465282732303136272c20277979797927292c2032292c726e645f62696e2831302c32302c32292066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n" +
                "<440000008c000dffffffff00000002353700000005302e3632350000001a313937302d30312d30312030303a30303a30302e30303030303000000005302e343632000000052d313539330000000733343235323332ffffffff000000033132310000000166000000045045484e0000000a323031352d30332d31370000000e19c49594365349b4597e3b08a11e44000000ae000d00000004585953420000000331343200000005302e3537390000001a313937302d30312d30312030303a30303a30302e30313030303000000005302e39363900000005323030383800000007313531373439300000001a323031352d30312d31372032303a34313a31392e343830363835000000033130300000000174000000045045484e0000000a323031352d30362d323000000011795f8b812b934d1a8e78b5b91153d0fb6444000000a7000d000000044f5a5a560000000332313900000005302e3136340000001a313937302d30312d30312030303a30303a30302e30323030303000000005302e363539000000062d313233303300000007393438393530380000001a323031352d30382d31332031373a31303a31392e37353235323100000001360000000166ffffffff0000000a323031352d30352d32300000000f2b4d5ff64690c3b3598ee5612f640e4400000097000d000000044f4c595800000002333000000005302e3731330000001a313937302d30312d30312030303a30303a30302e30333030303000000005302e363535000000043636313000000007363530343432380000001a323031352d30382d30382030303a34323a32342e353435363339000000033132330000000166ffffffff0000000a323031352d30312d3033ffffffff440000009f000d000000045449514200000002343200000005302e3638310000001a313937302d30312d30312030303a30303a30302e30343030303000000005302e363236000000052d3136303500000007383831343038360000001a323031352d30372d32382031353a30383a35332e34363234393500000002323800000001740000000443505357ffffffff0000000e3ba6dc3b7d2be392fe6938e1779a4400000095000d000000044c544f560000000331333700000005302e3736330000001a313937302d30312d30312030303a30303a30302e30353030303000000005302e3838320000000439303534ffffffff0000001a323031352d30342d32302030353a30393a30332e353830353734000000033130360000000166000000045045484e0000000a323031352d30312d3039ffffffff4400000093000d000000045a494d4e00000003313235ffffffff0000001a313937302d30312d30312030303a30303a30302e303630303030ffffffff00000005313135323400000007383333353236310000001a323031352d31302d32362030323a31303a35302e363838333934000000033131310000000174000000045045484e0000000a323031352d30382d3231ffffffff4400000093000d000000044f504a4f0000000331363800000005302e3130350000001a313937302d30312d30312030303a30303a30302e30373030303000000005302e353335000000052d3539323000000007373038303730340000001a323031352d30372d31312030393a31353a33382e3334323731370000000331303300000001660000000456544a57ffffffffffffffff440000009c000d00000004474c554f0000000331343500000005302e3533390000001a313937302d30312d30312030303a30303a30302e30383030303000000005302e37363700000005313432343200000007323439393932320000001a323031352d31312d30322030393a30313a33312e3331323830340000000238340000000166000000045045484e0000000a323031352d31312d3134ffffffff44000000a9000d000000045a5651450000000331303300000005302e3637330000001a313937302d30312d30312030303a30303a30302e303930303030ffffffff00000005313337323700000007373837353834360000001a323031352d31322d31322031333a31363a32362e3133343536320000000232320000000174000000045045484e0000000a323031352d30312d323000000012143380c9eba3677a1a79e435e43adc5c65ff440000009a000d000000044c4947590000000331393900000005302e3238340000001a313937302d30312d30312030303a30303a30302e313030303030ffffffff00000005333034323600000007333231353536320000001a323031352d30382d32312031343a35353a30372e30353537323200000002313100000001660000000456544a57ffffffff0000000dff703ac78ab314cd470b0c3912440000008d000d000000044d514e5400000002343300000005302e3538360000001a313937302d30312d30312030303a30303a30302e31313030303000000005302e333335000000053237303139ffffffffffffffff0000000232370000000174000000045045484e0000000a323031352d30372d31320000001326fb2e42faf56e8f80e354b807b13257ff9aef44000000ae000d00000004575743430000000332313300000005302e3736370000001a313937302d30312d30312030303a30303a30302e31323030303000000005302e35383000000005313336343000000007343132313932330000001a323031352d30382d30362030323a32373a33302e3436393736320000000237330000000166000000045045484e0000000a323031352d30342d33300000001271a7d5af11963708dd98ef54882aa2ade7d444000000a2000d00000004564647500000000331323000000005302e3834300000001a313937302d30312d30312030303a30303a30302e31333030303000000005302e373733000000043732323300000007373234313432330000001a323031352d31322d31382030373a33323a31382e34353630323500000002343300000001660000000456544a57ffffffff00000011244e44a80dfe27ec53135db215e7b83567440000009c000d00000004524d44470000000331333400000005302e3131300000001a313937302d30312d30312030303a30303a30302e31343030303000000005302e30343300000005323132323700000007373135353730380000001a323031352d30372d30332030343a31323a34352e373734323831000000023432000000017400000004435053570000000a323031352d30322d3234ffffffff4400000098000d0000000457464f5100000003323535ffffffff0000001a313937302d30312d30312030303a30303a30302e31353030303000000005302e31313600000005333135363900000007363638383237370000001a323031352d30352d31392030333a33303a34352e373739393939000000033132360000000174000000045045484e0000000a323031352d31322d3039ffffffff440000007e000d000000044d58444b00000002353600000005312e3030300000001a313937302d30312d30312030303a30303a30302e31363030303000000005302e353233000000062d33323337320000000736383834313332ffffffff0000000235380000000166ffffffff0000000a323031352d30312d3230ffffffff44000000a1000d00000004584d4b4a0000000331333900000005302e3834310000001a313937302d30312d30312030303a30303a30302e31373030303000000005302e333036000000053235383536ffffffff0000001a323031352d30352d31382030333a35303a32322e373331343337000000013200000001740000000456544a570000000a323031352d30362d32350000000d007cfb0119caf2bf845a6f383544000000a2000d0000000456494844ffffffffffffffff0000001a313937302d30312d30312030303a30303a30302e31383030303000000005302e35353000000005323232383000000007393130393834320000001a323031352d30312d32352031333a35313a33382e323730353833000000023934000000016600000004435053570000000a323031352d31302d32370000000e2d16f389a38364ded6fdc45bc4e944000000a3000d0000000457504e58ffffffff00000005302e3934370000001a313937302d30312d30312030303a30303a30302e31393030303000000005302e343135000000062d3137393333000000063637343236310000001a323031352d30332d30342031353a34333a31352e323133363836000000023433000000017400000004485952580000000a323031352d31322d31380000000ab34c0e8ff10cc560b7d144000000a3000d0000000459504f5600000002333600000005302e3637340000001a313937302d30312d30312030303a30303a30302e32303030303000000005302e303331000000052d3538383800000007313337353432330000001a323031352d31322d31302032303a35303a33352e38363636313400000001330000000174ffffffff0000000a323031352d30372d32330000000dd4abbe30fa8dac3d98a0ad9a5d44000000ac000d000000044e55484effffffff00000005302e3639340000001a313937302d30312d30312030303a30303a30302e32313030303000000005302e333339000000062d323532323600000007333532343734380000001a323031352d30352d30372030343a30373a31382e31353239363800000002333900000001740000000456544a570000000a323031352d30342d303400000012b8bef8a146872892a39be3cbc2648ab035d8440000008e000d00000004424f53450000000332343000000005302e3036300000001a313937302d30312d30312030303a30303a30302e32323030303000000005302e33373900000005323339303400000007393036393333390000001a323031352d30332d32312030333a34323a34322e3634333138360000000238340000000174ffffffffffffffffffffffff44000000ab000d00000004494e4b470000000331323400000005302e3836320000001a313937302d30312d30312030303a30303a30302e32333030303000000005302e343034000000062d333033383300000007373233333534320000001a323031352d30372d32312031363a34323a34372e3031323134380000000239390000000166ffffffff0000000a323031352d30382d32370000001287fc9283fc88f3322770c801b0dcc93a5b7e4400000097000d000000044655584300000002353200000005302e3734330000001a313937302d30312d30312030303a30303a30302e323430303030ffffffff000000062d313437323900000007313034323036340000001a323031352d30382d32312030323a31303a35382e393439363734000000023238000000017400000004435053570000000a323031352d30382d3239ffffffff44000000a4000d00000004554e595100000002373100000005302e3434320000001a313937302d30312d30312030303a30303a30302e32353030303000000005302e353339000000062d3232363131ffffffff0000001a323031352d31322d32332031383a34313a34322e3331393835390000000239380000000174000000045045484e0000000a323031352d30312d32360000000f28ed9799d877333fb267da984747bf4400000096000d000000044b424d51ffffffff00000005302e3238300000001a313937302d30312d30312030303a30303a30302e323630303030ffffffff000000053132323430ffffffff0000001a323031352d30382d31362030313a30323a35352e3736363632320000000232310000000166ffffffff0000000a323031352d30352d31390000000d6ade4604d381e7a21622353b1c4400000084000d000000044a534f4c00000003323433ffffffff0000001a313937302d30312d30312030303a30303a30302e32373030303000000005302e303638000000062d3137343638ffffffffffffffff0000000232300000000174ffffffff0000000a323031352d30362d3139000000113de02d0486e7ca29980769ca5bd6cf0969440000007f000d00000004484e535300000003313530ffffffff0000001a313937302d30312d30312030303a30303a30302e32383030303000000005302e3134380000000531343834310000000735393932343433ffffffff0000000232350000000166000000045045484effffffff0000000c14d6fcee032281b806c406af44000000a7000d00000004505a50420000000331303100000005302e3036320000001a313937302d30312d30312030303a30303a30302e323930303030ffffffff00000005313232333700000007393837383137390000001a323031352d30392d30332032323a31333a31382e38353234363500000002373900000001660000000456544a570000000a323031352d31322d31370000001012613a9aad982e7552ad62878845b99d44000000a9000d000000044f594e4e00000002323500000005302e3333390000001a313937302d30312d30312030303a30303a30302e33303030303000000005302e36323800000005323234313200000007343733363337380000001a323031352d31302d31302031323a31393a34322e35323832323400000003313036000000017400000004435053570000000a323031352d30372d30310000000d54133fffb67ecd0427669489db4400000076000dffffffff0000000331313700000005302e3536340000001a313937302d30312d30312030303a30303a30302e333130303030ffffffff000000052d353630340000000736333533303138ffffffff0000000238340000000166ffffffffffffffff0000000b2bad2507db6244336e008e440000007e000d00000004485652490000000332333300000005302e3232340000001a313937302d30312d30312030303a30303a30302e33323030303000000005302e3432350000000531303436390000000731373135323133ffffffff0000000238360000000166ffffffff0000000a323031352d30322d3032ffffffff440000009c000d000000044f59544f00000002393600000005302e3734310000001a313937302d30312d30312030303a30303a30302e33333030303000000005302e353238000000062d313232333900000007333439393632300000001a323031352d30322d30372032323a33353a30332e3231323236380000000231370000000166000000045045484e0000000a323031352d30332d3239ffffffff440000008b000d000000044c46435900000002363300000005302e3732320000001a313937302d30312d30312030303a30303a30302e333430303030ffffffff0000000532333334340000000739353233393832ffffffff00000003313233000000016600000004435053570000000a323031352d30352d31380000000e05e5c04eccd6e37b34cd1535bba444000000a7000d0000000447484c580000000331343800000005302e3330360000001a313937302d30312d30312030303a30303a30302e33353030303000000005302e363336000000062d333134353700000007323332323333370000001a323031352d31302d32322031323a30363a30352e353434373031000000023931000000017400000004485952580000000a323031352d30352d32310000000a571d91723004b702cb034400000097000d000000045954535a00000003313233ffffffff0000001a313937302d30312d30312030303a30303a30302e33363030303000000005302e35313900000005323235333400000007343434363233360000001a323031352d30372d32372030373a32333a33372e323333373131000000023533000000016600000004435053570000000a323031352d30312d3133ffffffff4400000096000d0000000453574c5500000003323531ffffffff0000001a313937302d30312d30312030303a30303a30302e33373030303000000005302e313739000000043737333400000007343038323437350000001a323031352d31302d32312031383a32343a33342e3430303334350000000236390000000166000000045045484e0000000a323031352d30342d3031ffffffff44000000a4000d0000000454514a4c00000003323435ffffffff0000001a313937302d30312d30312030303a30303a30302e33383030303000000005302e3836350000000439353136000000063932393334300000001a323031352d30352d32382030343a31383a31382e36343035363700000002363900000001660000000456544a570000000a323031352d30362d31320000000f6c3e51d7ebb10771321faf404e8c474400000091000d000000045245494a000000023934ffffffff0000001a313937302d30312d30312030303a30303a30302e33393030303000000005302e313330000000062d3239393234ffffffff0000001a323031352d30332d32302032323a31343a34362e32303437313800000003313133000000017400000004485952580000000a323031352d31322d3139ffffffff44000000a8000d000000044844485100000002393400000005302e3732330000001a313937302d30312d30312030303a30303a30302e34303030303000000005302e373330000000053139393730000000063635343133310000001a323031352d30312d31302032323a35363a30382e3438303435300000000238340000000174ffffffff0000000a323031352d30332d3035000000124f566b65a45338e9cdc1a7ee8675ada52d49440000009c000d00000004554d455500000002343000000005302e3030380000001a313937302d30312d30312030303a30303a30302e34313030303000000005302e383035000000062d313136323300000007343539393836320000001a323031352d31312d32302030343a30323a34342e3333353934370000000237360000000166000000045045484e0000000a323031352d30352d3137ffffffff44000000a0000d00000004594a494800000003313834ffffffff0000001a313937302d30312d30312030303a30303a30302e34323030303000000005302e33383300000005313736313400000007333130313637310000001a323031352d30312d32382031323a30353a34362e363833303031000000033130350000000174ffffffff0000000a323031352d31322d30370000000cec69cd73bb9bc595db6191ce4400000089000d000000044359584700000002323700000005302e3239320000001a313937302d30312d30312030303a30303a30302e34333030303000000005302e393533000000043339343400000006323439313635ffffffff0000000236370000000174ffffffff0000000a323031352d30332d30320000000e0148153e0c7f3f8fe4b5ab3421294400000099000d000000044d5254470000000331343300000005302e3032360000001a313937302d30312d30312030303a30303a30302e34343030303000000005302e393433000000062d323733323000000007313636373834320000001a323031352d30312d32342031393a35363a31352e3937333130390000000231310000000166ffffffff0000000a323031352d30312d3234ffffffff44000000aa000d00000004444f4e500000000332343600000005302e3635340000001a313937302d30312d30312030303a30303a30302e34353030303000000005302e35353600000005323734373700000007343136303031380000001a323031352d31322d31342030333a34303a30352e3931313833390000000232300000000174000000045045484e0000000a323031352d31302d32390000000e079201f56aa131cdcbc2a2b48e9944000000a9000d00000004495158530000000332333200000005302e3233310000001a313937302d30312d30312030303a30303a30302e34363030303000000005302e303439000000062d313831313300000007343030353232380000001a323031352d30362d31312031333a30303a30372e3234383138380000000138000000017400000004435053570000000a323031352d30382d31360000000dfa1f9224b1b8676508b7f8410044000000a4000dffffffff00000003313738ffffffff0000001a313937302d30312d30312030303a30303a30302e34373030303000000005302e393033000000062d313436323600000007323933343537300000001a323031352d30342d30342030383a35313a35342e3036383135340000000238380000000174ffffffff0000000a323031352d30372d303100000014843625632b6361431c477db646babb98ca08bea44400000097000d000000044855575a00000002393400000005302e3131300000001a313937302d30312d30312030303a30303a30302e34383030303000000005302e343230000000052d3337333600000007353638373531340000001a323031352d30312d30322031373a31383a30352e3632373633330000000237340000000166ffffffff0000000a323031352d30332d3239ffffffff440000009d000d000000045352454400000002363600000005302e3131330000001a313937302d30312d30312030303a30303a30302e34393030303000000005302e303630000000062d313035343300000007333636393337370000001a323031352d31302d32322030323a35333a30322e3338313335310000000237370000000174000000045045484effffffff0000000b7c3fd6883a93ef24a5e2bc\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">420000000c000000000000000044000000065000450000000900000000005300000004440000000650004500000009000000000053000000044500000009000000000053000000045300000004\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n" +
                "<44000000a8000d0000000450574c5a00000002393100000005302e3530340000001a313937302d30312d30312030303a30303a30302e303030303030ffffffff000000052d3739383500000007343233343632310000001a323031352d30312d32362031323a31373a31302e363535353938000000033130360000000166000000045045484e0000000a323031352d31322d3036000000112a4e91c5e439b2dd0da7bbd57172ba9cac440000008f000d00000004594c58470000000331313400000005302e3739320000001a313937302d30312d30312030303a30303a30302e303130303030ffffffff0000000531383230300000000737363830303832ffffffff000000023530000000017400000004435053570000000a323031352d30352d31330000001252bb50c9024d40ef1fb817f741ffc1a75cc34400000092000d00000004424b5850ffffffff00000005302e3735360000001a313937302d30312d30312030303a30303a30302e30323030303000000005302e393030000000062d3136393636ffffffff0000001a323031352d30372d30382030343a30393a30372e3132373837340000000135000000017400000004485952580000000a323031352d31302d3132ffffffff4400000096000d00000004485844420000000332333900000005302e3433340000001a313937302d30312d30312030303a30303a30302e30333030303000000005302e323335000000053235363238ffffffff0000001a323031352d30392d32302031383a30313a35362e37313437363800000003313134000000017400000004485952580000000a323031352d31312d3039ffffffff440000009d000d0000000454534c4f0000000331353800000005302e3035380000001a313937302d30312d30312030303a30303a30302e30343030303000000005302e333933000000062d313736363900000007373435393639300000001a323031352d31302d30372030303a32393a35372e353439393139000000023333000000016600000004485952580000000a323031352d30342d3038ffffffff4400000090000d00000004484a5558000000013800000005302e3137360000001a313937302d30312d30312030303a30303a30302e30353030303000000005302e31353500000005323530353700000007383334313835310000001a323031352d30322d30382030333a33333a34342e35353434373300000002383300000001660000000456544a57ffffffffffffffff44000000ab000d00000004535444540000000331303600000005302e3231390000001a313937302d30312d30312030303a30303a30302e30363030303000000005302e37373700000005323238383300000007353136383237310000001a323031352d31322d32392030353a30303a33392e3139373135310000000331323500000001740000000456544a570000000a323031352d30392d32350000000e66ca8556e244dbb8e993fcd9cb994400000090000d000000044d43495900000002323600000005302e3138390000001a313937302d30312d30312030303a30303a30302e30373030303000000005302e373535000000062d3231363334ffffffff0000001a323031352d31312d31342031373a34313a31382e38393931363900000001320000000174ffffffff0000000a323031352d30372d3134ffffffff440000009b000d000000044b53514400000002353100000005302e3238360000001a313937302d30312d30312030303a30303a30302e30383030303000000005302e323837000000053139313433ffffffff0000001a323031352d30372d31362030383a33363a35372e373737393837000000033132300000000174ffffffff0000000a323031352d30342d30360000000a84d512fb719934038208440000009d000d000000044a4a46470000000332313100000005302e3832320000001a313937302d30312d30312030303a30303a30302e30393030303000000005302e323735000000062d313831353700000007393639323732300000001a323031352d30352d32332030383a34303a33332e3431393237370000000231320000000174000000045045484e0000000a323031352d30372d3036ffffffff44000000a7000d0000000449584d490000000331313200000005302e3334370000001a313937302d30312d30312030303a30303a30302e31303030303000000005302e363537000000062d313930313700000007393630313134370000001a323031352d31302d30342030363a32323a31322e383039353930000000023737000000017400000004435053570000000a323031352d30342d32300000000a1a275b4d0f33f470bb5744000000a4000d0000000445464a420000000331393900000005302e3537360000001a313937302d30312d30312030303a30303a30302e31313030303000000005302e343330000000043530353900000007353031303134340000001a323031352d30332d30392031373a33343a34372e3631393630320000000233320000000174ffffffff0000000a323031352d30342d31350000000d003aea50240bc51a5a8d8550394400000097000d000000044a46424b0000000331333900000005302e3236350000001a313937302d30312d30312030303a30303a30302e31323030303000000005302e313832000000043332353500000007333732343636300000001a323031352d31322d31302031353a35363a32352e3535383733350000000239350000000174ffffffff0000000a323031352d30362d3131ffffffff440000009f000d000000044d44524e0000000331303600000005302e3136340000001a313937302d30312d30312030303a30303a30302e31333030303000000005302e343734000000062d3138383439000000063638343236390000001a323031352d31322d32382032303a35383a32362e30333732343400000002313900000001660000000448595258ffffffff0000000d39dc8c6c6bac60aabcf427617844000000a3000d000000045650474800000002343200000005302e3530330000001a313937302d30312d30312030303a30303a30302e31343030303000000005302e323033000000062d313537323000000007353837303336380000001a323031352d30352d32392030373a30363a33302e3337373730360000000234340000000174ffffffff0000000a323031352d30372d30310000000bd989264fe4513785e1e46e440000008d000d000000044f54485300000002373400000005302e3232340000001a313937302d30312d30312030303a30303a30302e31353030303000000005302e31313600000004393832310000000733393533393634ffffffff000000023132000000017400000004435053570000000a323031352d30322d30320000000d593e98c98e5fbd124072694ec244000000a3000d000000044e4746440000000134ffffffff0000001a313937302d30312d30312030303a30303a30302e31363030303000000005302e32363600000005313731353400000007323532343534320000001a323031352d30322d32322030393a33353a30362e36363236333500000001380000000174ffffffff0000000a323031352d31312d303200000013983fb81e53a335588dca1dd0b2eb543f32825b4400000091000d000000045151444f00000002313000000005302e3635330000001a313937302d30312d30312030303a30303a30302e31373030303000000005302e323533000000052d3132313200000007333437363834330000001a323031352d30312d32352032333a31393a34352e32343533373200000002343300000001660000000448595258ffffffffffffffff44000000aa000d00000004534f42520000000331333200000005302e3932350000001a313937302d30312d30312030303a30303a30302e31383030303000000005302e343334000000042d38343600000007333632383332300000001a323031352d30372d32372031373a32393a32342e303037373235000000023335000000016600000004435053570000000a323031352d30322d30370000000f66a1f432e1d00dbf2e91a04aa8bc1c44000000ab000d00000004554452450000000331303700000005302e3939370000001a313937302d30312d30312030303a30303a30302e31393030303000000005302e38353700000005313633383200000007343932313737350000001a323031352d30332d30382031303a35313a32322e303139353234000000023830000000016600000004485952580000000a323031352d31302d33300000000f671cfdeba385e53d2184bbb19b5da544000000aa000d0000000457424e450000000331323700000005302e3534350000001a313937302d30312d30312030303a30303a30302e32303030303000000005302e34303300000005313232353100000007383033333232330000001a323031352d30362d31362032313a30363a33312e3735303434310000000236300000000174ffffffff0000000a323031352d31322d303500000012c555ef19d90f612db25ad879a0b0ac6093f1440000007a000dffffffff0000000331393400000005302e3435330000001a313937302d30312d30312030303a30303a30302e323130303030ffffffff000000062d32363936380000000738373030363431ffffffff0000000234300000000174000000045045484e0000000a323031352d31322d3037ffffffff440000009e000d0000000447445450ffffffff00000005302e3232370000001a313937302d30312d30312030303a30303a30302e32323030303000000005302e343436000000062d333030393000000007323736323737390000001a323031352d31322d31322030333a35383a35302e38373830313500000002313100000001660000000456544a57ffffffff0000000e6b531e18079d752a1131d2fbde75440000008f000d00000004575a434a0000000332343400000005302e3937350000001a313937302d30312d30312030303a30303a30302e32333030303000000005302e3232320000000532353836360000000731343830363238ffffffff000000023330000000016600000004485952580000000a323031352d30312d32310000000d4b9d2a9fc1f84f032a59d613dd44000000ae000d000000044f5854500000000331393200000005302e3935370000001a313937302d30312d30312030303a30303a30302e32343030303000000005302e30393400000005323330363000000007333431303232300000001a323031352d30322d32352031373a32313a34342e393532383735000000023137000000017400000004485952580000000a323031352d31312d323300000012fcbb7bd33f08bfbfc083960994535679ebcd44000000a2000d000000044b5859440000000331353100000005302e3430300000001a313937302d30312d30312030303a30303a30302e32353030303000000005302e373534000000062d313833373000000007383236323230360000001a323031352d30342d31392031323a33373a30392e3538383935370000000231390000000166ffffffffffffffff0000001329b39aab7e35973ea15a97c402793839c148ef44000000ad000d00000004574d53520000000331393800000005302e3236350000001a313937302d30312d30312030303a30303a30302e32363030303000000005302e33333100000005313935303100000007373630303133310000001a323031352d31322d30382031363a34383a32352e333633353233000000033132330000000174ffffffff0000000a323031352d30382d303300000014d1df4c3da99136abd2ce1b77497791c2b8f4e7c94400000097000dffffffff0000000331333400000005302e3136320000001a313937302d30312d30312030303a30303a30302e32373030303000000005302e35323300000005323037373100000007323738343235380000001a323031352d31312d31372031353a31343a32312e31323236343700000001310000000174000000045045484e0000000a323031352d31322d3038ffffffff44000000a7000d00000004434c47450000000332343000000005302e3639330000001a313937302d30312d30312030303a30303a30302e32383030303000000005302e35353400000005313839393700000007313239353535300000001a323031352d30332d31322031353a34343a33372e3139353039370000000234310000000166000000045045484e0000000a323031352d30352d30390000000bf6eeea3fc2953f27ede8c044000000b0000d000000045843464f0000000332333100000005302e3335330000001a313937302d30312d30312030303a30303a30302e32393030303000000005302e39353400000005333133333100000007383239343437380000001a323031352d31302d32382032323a35313a31392e36383232313700000003313134000000016600000004485952580000000a323031352d30342d3031000000131e60f2343a5e725d5a66734923034956bd02aa44000000a1000d0000000459515953000000013600000005302e3034350000001a313937302d30312d30312030303a30303a30302e33303030303000000005302e37333200000005333139313700000007343636313037350000001a323031352d30362d31372030333a34333a33322e333937323233000000033131350000000166ffffffff0000000a323031352d31322d31320000000a60a87e6ca44f9dab2b61440000009d000d000000044b4a4b4e0000000332323100000005302e3639330000001a313937302d30312d30312030303a30303a30302e33313030303000000005302e393832000000062d333234373900000007313538373835320000001a323031352d30392d30342031303a33393a35332e36313236343200000002323300000001740000000456544a570000000a323031352d31322d3236ffffffff4400000095000d00000004485a4d440000000332333600000005302e3233310000001a313937302d30312d30312030303a30303a30302e33323030303000000005302e323835000000053237393932ffffffff0000001a323031352d30382d31382031343a32323a30352e383334313532000000023231000000017400000004485952580000000a323031352d30342d3036ffffffff4400000093000dffffffff00000003323139ffffffff0000001a313937302d30312d30312030303a30303a30302e33333030303000000005302e373138000000052d3236393700000007383132303236360000001a323031352d31312d30382031383a31373a33322e3336323935330000000235390000000166000000045045484effffffff0000000a40f24f2981d070ecd5f344000000a4000d00000004585a4d4d0000000332343600000005302e3436300000001a313937302d30312d30312030303a30303a30302e33343030303000000005302e3937320000000438323635000000063936333230390000001a323031352d30312d32322031343a35363a34352e343936303139000000033132360000000174ffffffff0000000a323031352d30322d31390000000d2738e2f83774df3ad8e1e6ba4a44000000a8000d000000044355465700000002363700000005302e3837310000001a313937302d30312d30312030303a30303a30302e33353030303000000005302e3233350000000331323500000007383037343433360000001a323031352d30392d32392030353a31303a35332e343037303834000000023937000000017400000004485952580000000a323031352d30312d30340000000f568acf3f12ab0f4ddf7eb106d30b1a44000000a8000d000000045642575a0000000332333800000005302e3832310000001a313937302d30312d30312030303a30303a30302e33363030303000000005302e30393200000005323634383700000007323535393938320000001a323031352d30372d33302030323a35343a33302e3836353137340000000235320000000166000000045045484e0000000a323031352d30312d30350000000cfb04dc12a5f0054cebaf228c4400000089000dffffffff0000000331393000000005302e3834320000001a313937302d30312d30312030303a30303a30302e33373030303000000005302e363537000000062d313831333100000006333034323135ffffffff0000000236380000000174000000045045484e0000000a323031352d30362d30380000000b40808e49636de05a311bea4400000098000d00000004454d50500000000332333600000005302e3537350000001a313937302d30312d30312030303a30303a30302e333830303030ffffffff000000062d323939353600000007363033333235390000001a323031352d30372d31362031353a35303a35372e36333133313700000002353300000001740000000456544a570000000a323031352d30352d3137ffffffff4400000094000d000000045a4b585000000002343000000005302e3235320000001a313937302d30312d30312030303a30303a30302e33393030303000000005302e303133000000053332363530ffffffff0000001a323031352d30372d31362031333a31333a34392e353038343632000000023933000000017400000004485952580000000a323031352d30392d3232ffffffff44000000a5000d00000004464d4453000000013500000005302e3631370000001a313937302d30312d30312030303a30303a30302e34303030303000000005302e31313200000005313039303900000007323734363639360000001a323031352d30382d32322032313a32333a31352e3436383933300000000237380000000174000000045045484e0000000a323031352d30352d30330000000b48f5da38103592256a3b964400000092000d00000004495456580000000331393700000005302e3939370000001a313937302d30312d30312030303a30303a30302e34313030303000000005302e393438000000052d3638353100000007353334343533330000001a323031352d30362d32382032323a32373a32322e39303431353700000002353900000001740000000456544a57ffffffffffffffff44000000a4000dffffffff00000002383100000005302e3331380000001a313937302d30312d30312030303a30303a30302e34323030303000000005302e34373600000005313333313400000007383232353535320000001a323031352d30312d31332030333a34333a32352e33313539303800000001370000000166000000045045484e0000000a323031352d30372d31330000000e68d74fc2ca1ad35d9f47589c57204400000098000d00000004544c594d00000002363100000005302e3735380000001a313937302d30312d30312030303a30303a30302e34333030303000000005302e303139000000062d323531363000000007383832303338360000001a323031352d30342d31362031373a35343a32332e3631343634360000000235380000000174ffffffff0000000a323031352d31302d3138ffffffff4400000087000d00000004514d494f000000023634ffffffff0000001a313937302d30312d30312030303a30303a30302e34343030303000000005302e343131000000062d31393730340000000738323130383932ffffffff0000000233340000000166ffffffff0000000a323031352d30372d31330000000efb08dddaaad2d5bab2d190e1692b4400000092000d000000044246435500000002313400000005302e3332390000001a313937302d30312d30312030303a30303a30302e34353030303000000005302e323631000000062d31363631390000000738373733323737ffffffff0000000231370000000174000000045045484e0000000a323031352d30322d323700000010489e307c3fb023e5f9a90b86ebce31ff440000009c000d00000004524a495900000002313400000005302e3539320000001a313937302d30312d30312030303a30303a30302e34363030303000000005302e363936000000062d323932373900000007363430393031330000001a323031352d31302d33302031333a34393a33362e323031353135000000023836000000016600000004435053570000000a323031352d30312d3035ffffffff440000009e000d000000044a4e4c560000000332303600000005302e3736360000001a313937302d30312d30312030303a30303a30302e34373030303000000005302e343830000000062d313630373700000007313937313433320000001a323031352d30392d31342031353a32343a32342e35393635303700000003313235000000016600000004485952580000000a323031352d30382d3039ffffffff44000000a8000d000000044858584e0000000331373300000005302e3737320000001a313937302d30312d30312030303a30303a30302e343830303030ffffffff00000005313535303400000007313434303033340000001a323031352d30372d30352032323a31323a35352e363633313439000000033131380000000174000000045045484e0000000a323031352d30362d313500000010870211f5bb0cc5754c7697120eed2c174400000082000d000000045358514500000002383600000005302e3335360000001a313937302d30312d30312030303a30303a30302e34393030303000000005302e343238000000062d31303232310000000732353634363235ffffffff0000000238390000000166000000045045484e0000000a323031352d31302d3038ffffffff\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n";
        assertHexScript(nf, NetworkFacadeImpl.INSTANCE, script, new DefaultWireParserConfiguration());
    }

    @Test
    public void testPreparedStatement() throws Exception {
        TestUtils.assertMemoryLeak(() -> {
            final CountDownLatch haltLatch = new CountDownLatch(1);
            final AtomicBoolean running = new AtomicBoolean(true);
            try {
                startBasicServer(
                        NetworkFacadeImpl.INSTANCE,
                        new DefaultWireParserConfiguration() {
                            @Override
                            public boolean getDumpNetworkTraffic() {
                                return true;
                            }
                        },
                        haltLatch,
                        running
                );

                Properties properties = new Properties();
                properties.setProperty("user", "xyz");
                properties.setProperty("password", "oh");
                properties.setProperty("sslmode", "disable");

                final Connection connection = DriverManager.getConnection("jdbc:postgresql://127.0.0.1:9120/nabu_app", properties);
                PreparedStatement statement = connection.prepareStatement("select 1,2,3 from long_sequence(1)");
                Statement statement1 = connection.createStatement();

                final String expected = "1[INTEGER],2[INTEGER],3[INTEGER]\n" +
                        "1,2,3\n";

                StringSink sink = new StringSink();
                for (int i = 0; i < 10; i++) {
                    sink.clear();
                    ResultSet rs = statement.executeQuery();

                    statement1.executeQuery("select 1 from long_sequence(2)");
                    assertResultSet(expected, sink, rs);
                    rs.close();
                }
                connection.close();
            } finally {
                running.set(false);
                haltLatch.await();
            }
        });
    }

    @Test
    public void testLargeOutputHex() throws Exception {
        String script = ">0000007300030000757365720078797a006461746162617365006e6162755f61707000636c69656e745f656e636f64696e67005554463800446174655374796c650049534f0054696d655a6f6e65004575726f70652f4c6f6e646f6e0065787472615f666c6f61745f64696769747300320000\n" +
                "<520000000800000003\n" +
                ">70000000076f6800\n" +
                "<520000000800000000530000001154696d655a6f6e6500474d5400530000001d6170706c69636174696f6e5f6e616d65005175657374444200530000001e7365727665725f76657273696f6e5f6e756d00313030303030005300000019696e74656765725f6461746574696d6573006f6e005a0000000549\n" +
                ">5000000022005345542065787472615f666c6f61745f646967697473203d2033000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000003700534554206170706c69636174696f6e5f6e616d65203d2027506f737467726553514c204a4442432044726976657227000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000002b0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002b0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002b0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002b0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f310073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f310000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f310050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f320073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f320000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f320050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f330073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f330000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f330050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f340073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f340000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f340050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f350073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f350000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f350050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002e535f360073656c65637420312c322c332066726f6d206c6f6e675f73657175656e636528353029000000420000000f00535f360000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<4400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<44000000150003000000013100000001320000000133440000001500030000000131000000013200000001334400000015000300000001310000000132000000013344000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f360050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">5800000004\n";

        NetworkFacade nf = new NetworkFacadeImpl() {
            boolean good = false;

            @Override
            public int send(long fd, long buffer, int bufferLen) {
                if (good) {
                    good = false;
                    return super.send(fd, buffer, bufferLen);
                }

                good = true;
                return 0;
            }
        };

        assertHexScript(NetworkFacadeImpl.INSTANCE, nf, script, new DefaultWireParserConfiguration() {
            @Override
            public int getSendBufferSize() {
                return 512;
            }
        });
    }

    @Test
    public void testLargeOutput() throws Exception {
        TestUtils.assertMemoryLeak(() -> {

            final String expected = "1[INTEGER],2[INTEGER],3[INTEGER]\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n" +
                    "1,2,3\n";

            final CountDownLatch haltLatch = new CountDownLatch(1);
            final AtomicBoolean running = new AtomicBoolean(true);
            try {
                startBasicServer(
                        NetworkFacadeImpl.INSTANCE,
                        new DefaultWireParserConfiguration() {
                            @Override
                            public boolean getDumpNetworkTraffic() {
                                return true;
                            }

                            @Override
                            public int getSendBufferSize() {
                                return 512;
                            }
                        },
                        haltLatch,
                        running
                );

                Properties properties = new Properties();
                properties.setProperty("user", "xyz");
                properties.setProperty("password", "oh");
                properties.setProperty("sslmode", "disable");

                final Connection connection = DriverManager.getConnection("jdbc:postgresql://127.0.0.1:9120/nabu_app", properties);
                PreparedStatement statement = connection.prepareStatement("select 1,2,3 from long_sequence(50)");
                Statement statement1 = connection.createStatement();

                StringSink sink = new StringSink();
                for (int i = 0; i < 10; i++) {
                    sink.clear();
                    ResultSet rs = statement.executeQuery();

                    statement1.executeQuery("select 1 from long_sequence(2)");
                    assertResultSet(expected, sink, rs);
                    rs.close();
                }
                connection.close();
            } finally {
                running.set(false);
                haltLatch.await();
            }
        });
    }

    @Test
    public void testPreparedStatementHex() throws Exception {
        final String script = ">0000007300030000757365720078797a006461746162617365006e6162755f61707000636c69656e745f656e636f64696e67005554463800446174655374796c650049534f0054696d655a6f6e65004575726f70652f4c6f6e646f6e0065787472615f666c6f61745f64696769747300320000\n" +
                "<520000000800000003\n" +
                ">70000000076f6800\n" +
                "<520000000800000000530000001154696d655a6f6e6500474d5400530000001d6170706c69636174696f6e5f6e616d65005175657374444200530000001e7365727665725f76657273696f6e5f6e756d00313030303030005300000019696e74656765725f6461746574696d6573006f6e005a0000000549\n" +
                ">5000000022005345542065787472615f666c6f61745f646967697473203d2033000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000003700534554206170706c69636174696f6e5f6e616d65203d2027506f737467726553514c204a4442432044726976657227000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f310073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f310000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f310050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f320073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f320000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f320050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f330073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f330000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f330050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f340073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f340000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f340050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f350073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f350000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f350050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f360073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f360000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f360050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">5800000004\n";

        assertPreparedStatementHex(NetworkFacadeImpl.INSTANCE, new DefaultWireParserConfiguration() {
            @Override
            public boolean getDumpNetworkTraffic() {
                return true;
            }
        });
    }

    @Test
    public void testPreparedStatementHexSendFlowControl() throws Exception {

        NetworkFacade nf = new NetworkFacadeImpl() {
            boolean good = false;

            @Override
            public int send(long fd, long buffer, int bufferLen) {
                if (good) {
                    good = false;
                    return super.send(fd, buffer, bufferLen);
                }

                good = true;
                return 0;
            }
        };

        WireParserConfiguration configuration = new DefaultWireParserConfiguration() {
            @Override
            public boolean getDumpNetworkTraffic() {
                return true;
            }

            @Override
            public NetworkFacade getNetworkFacade() {
                return nf;
            }

            @Override
            public int getIdleSendCountBeforeGivingUp() {
                return 0;
            }
        };
        assertPreparedStatementHex(nf, configuration);
    }

    private void assertPreparedStatementHex(NetworkFacade nf, WireParserConfiguration configuration) throws Exception {
        assertHexScript(NetworkFacadeImpl.INSTANCE, nf, ">0000007300030000757365720078797a006461746162617365006e6162755f61707000636c69656e745f656e636f64696e67005554463800446174655374796c650049534f0054696d655a6f6e65004575726f70652f4c6f6e646f6e0065787472615f666c6f61745f64696769747300320000\n" +
                "<520000000800000003\n" +
                ">70000000076f6800\n" +
                "<520000000800000000530000001154696d655a6f6e6500474d5400530000001d6170706c69636174696f6e5f6e616d65005175657374444200530000001e7365727665725f76657273696f6e5f6e756d00313030303030005300000019696e74656765725f6461746574696d6573006f6e005a0000000549\n" +
                ">5000000022005345542065787472615f666c6f61745f646967697473203d2033000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000003700534554206170706c69636174696f6e5f6e616d65203d2027506f737467726553514c204a4442432044726976657227000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002a0073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">50000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f310073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f310000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f310050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f320073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f320000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f320050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f330073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f330000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f330050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f340073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f340000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f340050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f350073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f350000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f350050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">500000002d535f360073656c65637420312c322c332066726f6d206c6f6e675f73657175656e6365283129000000420000000f00535f360000000000000044000000065000450000000900000000005300000004\n" +
                "<54000000420003310000000000000000000017000000000000000032000000000000000000001700000000000000003300000000000000000000170000000000000000\n" +
                "<44000000150003000000013100000001320000000133\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">430000000953535f360050000000260073656c65637420312066726f6d206c6f6e675f73657175656e6365283229000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<3300000004\n" +
                "<540000001a00013100000000000000000000170000000000000000\n" +
                "<440000000b00010000000131440000000b00010000000131\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">5800000004\n", configuration);
    }

    @Test
    public void testPreparedStatementHexSendFlowControl2() throws Exception {

        // the objective of this setup is to exercise send retry behaviour

        NetworkFacade nf = new NetworkFacadeImpl() {
            int counter = 0;
            int counterBreak = 2;

            @Override
            public int send(long fd, long buffer, int bufferLen) {
                if (counter++ % counterBreak == 0) {
                    return super.send(fd, buffer, bufferLen);
                }
                return 0;
            }
        };

        WireParserConfiguration configuration = new DefaultWireParserConfiguration() {
            @Override
            public boolean getDumpNetworkTraffic() {
                return true;
            }

            @Override
            public NetworkFacade getNetworkFacade() {
                return nf;
            }

            @Override
            public int getIdleSendCountBeforeGivingUp() {
                return 1;
            }
        };

        assertPreparedStatementHex(nf, configuration);
    }

    @Test
    public void testPreparedStatementHexSendFlowControl3() throws Exception {

        // the objective of this setup is to exercise send retry behaviour

        NetworkFacade nf = new NetworkFacadeImpl() {
            int counter = 0;
            int counterBreak = 3; // another branch of retry logic

            @Override
            public int send(long fd, long buffer, int bufferLen) {
                if (counter++ % counterBreak == 0) {
                    return super.send(fd, buffer, bufferLen);
                }
                return 0;
            }
        };

        WireParserConfiguration configuration = new DefaultWireParserConfiguration() {
            @Override
            public boolean getDumpNetworkTraffic() {
                return true;
            }

            @Override
            public NetworkFacade getNetworkFacade() {
                return nf;
            }

            @Override
            public int getIdleSendCountBeforeGivingUp() {
                return 1;
            }
        };

        assertPreparedStatementHex(nf, configuration);
    }

    @Test
    public void testSimple() throws Exception {
        TestUtils.assertMemoryLeak(() -> {
            final CountDownLatch haltLatch = new CountDownLatch(1);
            final AtomicBoolean running = new AtomicBoolean(true);
            try {
                startBasicServer(NetworkFacadeImpl.INSTANCE,
                        new DefaultWireParserConfiguration(),
                        haltLatch,
                        running
                );

                Properties properties = new Properties();
                properties.setProperty("user", "xyz");
                properties.setProperty("password", "oh");
                properties.setProperty("sslmode", "disable");

                final Connection connection = DriverManager.getConnection("jdbc:postgresql://127.0.0.1:9120/nabu_app", properties);
                Statement statement = connection.createStatement();
                ResultSet rs = statement.executeQuery(
                        "select " +
                                "rnd_str(4,4,4) s, " +
                                "rnd_int(0, 256, 4) i, " +
                                "rnd_double(4) d, " +
                                "timestamp_sequence(to_timestamp(0),10000) t, " +
                                "rnd_float(4) f, " +
                                "rnd_short() _short, " +
                                "rnd_long(0, 10000000, 5) l, " +
                                "rnd_timestamp(to_timestamp('2015','yyyy'),to_timestamp('2016','yyyy'),2) ts2, " +
                                "rnd_byte(0,127) bb, " +
                                "rnd_boolean() b, " +
                                "rnd_symbol(4,4,4,2), " +
                                "rnd_date(to_date('2015', 'yyyy'), to_date('2016', 'yyyy'), 2)," +
                                "rnd_bin(10,20,2) " +
                                "from long_sequence(50)");

                final String expected = "s[VARCHAR],i[INTEGER],d[DOUBLE],t[TIMESTAMP],f[REAL],_short[SMALLINT],l[BIGINT],ts2[TIMESTAMP],bb[SMALLINT],b[BIT],rnd_symbol[VARCHAR],rnd_date[DATE],rnd_bin[BINARY]\n" +
                        "null,57,0.62500000,1970-01-01 00:00:00.0,0.4620,-1593,3425232,null,121,false,PEHN,2015-03-17,00000000 19 c4 95 94 36 53 49 b4 59 7e 3b 08 a1 1e\n" +
                        "XYSB,142,0.57900000,1970-01-01 00:00:00.01,0.9690,20088,1517490,2015-01-17 20:41:19.480685,100,true,PEHN,2015-06-20,00000000 79 5f 8b 81 2b 93 4d 1a 8e 78 b5 b9 11 53 d0 fb\n" +
                        "00000010 64\n" +
                        "OZZV,219,0.16400000,1970-01-01 00:00:00.02,0.6590,-12303,9489508,2015-08-13 17:10:19.752521,6,false,null,2015-05-20,00000000 2b 4d 5f f6 46 90 c3 b3 59 8e e5 61 2f 64 0e\n" +
                        "OLYX,30,0.71300000,1970-01-01 00:00:00.03,0.6550,6610,6504428,2015-08-08 00:42:24.545639,123,false,null,2015-01-03,null\n" +
                        "TIQB,42,0.68100000,1970-01-01 00:00:00.04,0.6260,-1605,8814086,2015-07-28 15:08:53.462495,28,true,CPSW,null,00000000 3b a6 dc 3b 7d 2b e3 92 fe 69 38 e1 77 9a\n" +
                        "LTOV,137,0.76300000,1970-01-01 00:00:00.05,0.8820,9054,null,2015-04-20 05:09:03.580574,106,false,PEHN,2015-01-09,null\n" +
                        "ZIMN,125,null,1970-01-01 00:00:00.06,null,11524,8335261,2015-10-26 02:10:50.688394,111,true,PEHN,2015-08-21,null\n" +
                        "OPJO,168,0.10500000,1970-01-01 00:00:00.07,0.5350,-5920,7080704,2015-07-11 09:15:38.342717,103,false,VTJW,null,null\n" +
                        "GLUO,145,0.53900000,1970-01-01 00:00:00.08,0.7670,14242,2499922,2015-11-02 09:01:31.312804,84,false,PEHN,2015-11-14,null\n" +
                        "ZVQE,103,0.67300000,1970-01-01 00:00:00.09,null,13727,7875846,2015-12-12 13:16:26.134562,22,true,PEHN,2015-01-20,00000000 14 33 80 c9 eb a3 67 7a 1a 79 e4 35 e4 3a dc 5c\n" +
                        "00000010 65 ff\n" +
                        "LIGY,199,0.28400000,1970-01-01 00:00:00.1,null,30426,3215562,2015-08-21 14:55:07.055722,11,false,VTJW,null,00000000 ff 70 3a c7 8a b3 14 cd 47 0b 0c 39 12\n" +
                        "MQNT,43,0.58600000,1970-01-01 00:00:00.11,0.3350,27019,null,null,27,true,PEHN,2015-07-12,00000000 26 fb 2e 42 fa f5 6e 8f 80 e3 54 b8 07 b1 32 57\n" +
                        "00000010 ff 9a ef\n" +
                        "WWCC,213,0.76700000,1970-01-01 00:00:00.12,0.5800,13640,4121923,2015-08-06 02:27:30.469762,73,false,PEHN,2015-04-30,00000000 71 a7 d5 af 11 96 37 08 dd 98 ef 54 88 2a a2 ad\n" +
                        "00000010 e7 d4\n" +
                        "VFGP,120,0.84000000,1970-01-01 00:00:00.13,0.7730,7223,7241423,2015-12-18 07:32:18.456025,43,false,VTJW,null,00000000 24 4e 44 a8 0d fe 27 ec 53 13 5d b2 15 e7 b8 35\n" +
                        "00000010 67\n" +
                        "RMDG,134,0.11000000,1970-01-01 00:00:00.14,0.0430,21227,7155708,2015-07-03 04:12:45.774281,42,true,CPSW,2015-02-24,null\n" +
                        "WFOQ,255,null,1970-01-01 00:00:00.15,0.1160,31569,6688277,2015-05-19 03:30:45.779999,126,true,PEHN,2015-12-09,null\n" +
                        "MXDK,56,1.00000000,1970-01-01 00:00:00.16,0.5230,-32372,6884132,null,58,false,null,2015-01-20,null\n" +
                        "XMKJ,139,0.84100000,1970-01-01 00:00:00.17,0.3060,25856,null,2015-05-18 03:50:22.731437,2,true,VTJW,2015-06-25,00000000 00 7c fb 01 19 ca f2 bf 84 5a 6f 38 35\n" +
                        "VIHD,null,null,1970-01-01 00:00:00.18,0.5500,22280,9109842,2015-01-25 13:51:38.270583,94,false,CPSW,2015-10-27,00000000 2d 16 f3 89 a3 83 64 de d6 fd c4 5b c4 e9\n" +
                        "WPNX,null,0.94700000,1970-01-01 00:00:00.19,0.4150,-17933,674261,2015-03-04 15:43:15.213686,43,true,HYRX,2015-12-18,00000000 b3 4c 0e 8f f1 0c c5 60 b7 d1\n" +
                        "YPOV,36,0.67400000,1970-01-01 00:00:00.2,0.0310,-5888,1375423,2015-12-10 20:50:35.866614,3,true,null,2015-07-23,00000000 d4 ab be 30 fa 8d ac 3d 98 a0 ad 9a 5d\n" +
                        "NUHN,null,0.69400000,1970-01-01 00:00:00.21,0.3390,-25226,3524748,2015-05-07 04:07:18.152968,39,true,VTJW,2015-04-04,00000000 b8 be f8 a1 46 87 28 92 a3 9b e3 cb c2 64 8a b0\n" +
                        "00000010 35 d8\n" +
                        "BOSE,240,0.06000000,1970-01-01 00:00:00.22,0.3790,23904,9069339,2015-03-21 03:42:42.643186,84,true,null,null,null\n" +
                        "INKG,124,0.86200000,1970-01-01 00:00:00.23,0.4040,-30383,7233542,2015-07-21 16:42:47.012148,99,false,null,2015-08-27,00000000 87 fc 92 83 fc 88 f3 32 27 70 c8 01 b0 dc c9 3a\n" +
                        "00000010 5b 7e\n" +
                        "FUXC,52,0.74300000,1970-01-01 00:00:00.24,null,-14729,1042064,2015-08-21 02:10:58.949674,28,true,CPSW,2015-08-29,null\n" +
                        "UNYQ,71,0.44200000,1970-01-01 00:00:00.25,0.5390,-22611,null,2015-12-23 18:41:42.319859,98,true,PEHN,2015-01-26,00000000 28 ed 97 99 d8 77 33 3f b2 67 da 98 47 47 bf\n" +
                        "KBMQ,null,0.28000000,1970-01-01 00:00:00.26,null,12240,null,2015-08-16 01:02:55.766622,21,false,null,2015-05-19,00000000 6a de 46 04 d3 81 e7 a2 16 22 35 3b 1c\n" +
                        "JSOL,243,null,1970-01-01 00:00:00.27,0.0680,-17468,null,null,20,true,null,2015-06-19,00000000 3d e0 2d 04 86 e7 ca 29 98 07 69 ca 5b d6 cf 09\n" +
                        "00000010 69\n" +
                        "HNSS,150,null,1970-01-01 00:00:00.28,0.1480,14841,5992443,null,25,false,PEHN,null,00000000 14 d6 fc ee 03 22 81 b8 06 c4 06 af\n" +
                        "PZPB,101,0.06200000,1970-01-01 00:00:00.29,null,12237,9878179,2015-09-03 22:13:18.852465,79,false,VTJW,2015-12-17,00000000 12 61 3a 9a ad 98 2e 75 52 ad 62 87 88 45 b9 9d\n" +
                        "OYNN,25,0.33900000,1970-01-01 00:00:00.3,0.6280,22412,4736378,2015-10-10 12:19:42.528224,106,true,CPSW,2015-07-01,00000000 54 13 3f ff b6 7e cd 04 27 66 94 89 db\n" +
                        "null,117,0.56400000,1970-01-01 00:00:00.31,null,-5604,6353018,null,84,false,null,null,00000000 2b ad 25 07 db 62 44 33 6e 00 8e\n" +
                        "HVRI,233,0.22400000,1970-01-01 00:00:00.32,0.4250,10469,1715213,null,86,false,null,2015-02-02,null\n" +
                        "OYTO,96,0.74100000,1970-01-01 00:00:00.33,0.5280,-12239,3499620,2015-02-07 22:35:03.212268,17,false,PEHN,2015-03-29,null\n" +
                        "LFCY,63,0.72200000,1970-01-01 00:00:00.34,null,23344,9523982,null,123,false,CPSW,2015-05-18,00000000 05 e5 c0 4e cc d6 e3 7b 34 cd 15 35 bb a4\n" +
                        "GHLX,148,0.30600000,1970-01-01 00:00:00.35,0.6360,-31457,2322337,2015-10-22 12:06:05.544701,91,true,HYRX,2015-05-21,00000000 57 1d 91 72 30 04 b7 02 cb 03\n" +
                        "YTSZ,123,null,1970-01-01 00:00:00.36,0.5190,22534,4446236,2015-07-27 07:23:37.233711,53,false,CPSW,2015-01-13,null\n" +
                        "SWLU,251,null,1970-01-01 00:00:00.37,0.1790,7734,4082475,2015-10-21 18:24:34.400345,69,false,PEHN,2015-04-01,null\n" +
                        "TQJL,245,null,1970-01-01 00:00:00.38,0.8650,9516,929340,2015-05-28 04:18:18.640567,69,false,VTJW,2015-06-12,00000000 6c 3e 51 d7 eb b1 07 71 32 1f af 40 4e 8c 47\n" +
                        "REIJ,94,null,1970-01-01 00:00:00.39,0.1300,-29924,null,2015-03-20 22:14:46.204718,113,true,HYRX,2015-12-19,null\n" +
                        "HDHQ,94,0.72300000,1970-01-01 00:00:00.4,0.7300,19970,654131,2015-01-10 22:56:08.48045,84,true,null,2015-03-05,00000000 4f 56 6b 65 a4 53 38 e9 cd c1 a7 ee 86 75 ad a5\n" +
                        "00000010 2d 49\n" +
                        "UMEU,40,0.00800000,1970-01-01 00:00:00.41,0.8050,-11623,4599862,2015-11-20 04:02:44.335947,76,false,PEHN,2015-05-17,null\n" +
                        "YJIH,184,null,1970-01-01 00:00:00.42,0.3830,17614,3101671,2015-01-28 12:05:46.683001,105,true,null,2015-12-07,00000000 ec 69 cd 73 bb 9b c5 95 db 61 91 ce\n" +
                        "CYXG,27,0.29200000,1970-01-01 00:00:00.43,0.9530,3944,249165,null,67,true,null,2015-03-02,00000000 01 48 15 3e 0c 7f 3f 8f e4 b5 ab 34 21 29\n" +
                        "MRTG,143,0.02600000,1970-01-01 00:00:00.44,0.9430,-27320,1667842,2015-01-24 19:56:15.973109,11,false,null,2015-01-24,null\n" +
                        "DONP,246,0.65400000,1970-01-01 00:00:00.45,0.5560,27477,4160018,2015-12-14 03:40:05.911839,20,true,PEHN,2015-10-29,00000000 07 92 01 f5 6a a1 31 cd cb c2 a2 b4 8e 99\n" +
                        "IQXS,232,0.23100000,1970-01-01 00:00:00.46,0.0490,-18113,4005228,2015-06-11 13:00:07.248188,8,true,CPSW,2015-08-16,00000000 fa 1f 92 24 b1 b8 67 65 08 b7 f8 41 00\n" +
                        "null,178,null,1970-01-01 00:00:00.47,0.9030,-14626,2934570,2015-04-04 08:51:54.068154,88,true,null,2015-07-01,00000000 84 36 25 63 2b 63 61 43 1c 47 7d b6 46 ba bb 98\n" +
                        "00000010 ca 08 be a4\n" +
                        "HUWZ,94,0.11000000,1970-01-01 00:00:00.48,0.4200,-3736,5687514,2015-01-02 17:18:05.627633,74,false,null,2015-03-29,null\n" +
                        "SRED,66,0.11300000,1970-01-01 00:00:00.49,0.0600,-10543,3669377,2015-10-22 02:53:02.381351,77,true,PEHN,null,00000000 7c 3f d6 88 3a 93 ef 24 a5 e2 bc\n";

                StringSink sink = new StringSink();

                // dump metadata
                assertResultSet(expected, sink, rs);
                connection.close();
            } finally {
                running.set(false);
                haltLatch.await();
            }
        });
    }

    @Test
    public void testSimpleHex() throws Exception {
        // this is a HEX encoded bytes of the same script as 'testSimple' sends using postgres jdbc driver
        String script = ">0000007300030000757365720078797a006461746162617365006e6162755f61707000636c69656e745f656e636f64696e67005554463800446174655374796c650049534f0054696d655a6f6e65004575726f70652f4c6f6e646f6e0065787472615f666c6f61745f64696769747300320000\n" +
                "<520000000800000003\n" +
                ">70000000076f6800\n" +
                "<520000000800000000530000001154696d655a6f6e6500474d5400530000001d6170706c69636174696f6e5f6e616d65005175657374444200530000001e7365727665725f76657273696f6e5f6e756d00313030303030005300000019696e74656765725f6461746574696d6573006f6e005a0000000549\n" +
                ">5000000022005345542065787472615f666c6f61745f646967697473203d2033000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">420000000c00000000000000004500000009000000000153000000044500000009000000000153000000045300000004500000003700534554206170706c69636174696f6e5f6e616d65203d2027506f737467726553514c204a4442432044726976657227000000420000000c0000000000000000450000000900000000015300000004\n" +
                "<31000000045a0000000549\n" +
                ">420000000c0000000000000000450000000900000000015300000004\n" +
                ">450000000900000000015300000004\n" +
                ">5300000004\n" +
                ">50000001a20073656c65637420726e645f73747228342c342c342920732c20726e645f696e7428302c203235362c20342920692c20726e645f646f75626c6528342920642c2074696d657374616d705f73657175656e636528746f5f74696d657374616d702830292c31303030302920742c20726e645f666c6f617428342920662c20726e645f73686f72742829205f73686f72742c20726e645f6c6f6e6728302c2031303030303030302c203529206c2c20726e645f74696d657374616d7028746f5f74696d657374616d70282732303135272c277979797927292c746f5f74696d657374616d70282732303136272c277979797927292c3229207473322c20726e645f6279746528302c313237292062622c20726e645f626f6f6c65616e282920622c20726e645f73796d626f6c28342c342c342c32292c20726e645f6461746528746f5f64617465282732303135272c20277979797927292c20746f5f64617465282732303136272c20277979797927292c2032292c726e645f62696e2831302c32302c32292066726f6d206c6f6e675f73657175656e636528353029000000420000000c000000000000000044000000065000450000000900000000005300000004\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n" +
                "<440000008c000dffffffff00000002353700000005302e3632350000001a313937302d30312d30312030303a30303a30302e30303030303000000005302e343632000000052d313539330000000733343235323332ffffffff000000033132310000000166000000045045484e0000000a323031352d30332d31370000000e19c49594365349b4597e3b08a11e44000000ae000d00000004585953420000000331343200000005302e3537390000001a313937302d30312d30312030303a30303a30302e30313030303000000005302e39363900000005323030383800000007313531373439300000001a323031352d30312d31372032303a34313a31392e343830363835000000033130300000000174000000045045484e0000000a323031352d30362d323000000011795f8b812b934d1a8e78b5b91153d0fb6444000000a7000d000000044f5a5a560000000332313900000005302e3136340000001a313937302d30312d30312030303a30303a30302e30323030303000000005302e363539000000062d313233303300000007393438393530380000001a323031352d30382d31332031373a31303a31392e37353235323100000001360000000166ffffffff0000000a323031352d30352d32300000000f2b4d5ff64690c3b3598ee5612f640e4400000097000d000000044f4c595800000002333000000005302e3731330000001a313937302d30312d30312030303a30303a30302e30333030303000000005302e363535000000043636313000000007363530343432380000001a323031352d30382d30382030303a34323a32342e353435363339000000033132330000000166ffffffff0000000a323031352d30312d3033ffffffff440000009f000d000000045449514200000002343200000005302e3638310000001a313937302d30312d30312030303a30303a30302e30343030303000000005302e363236000000052d3136303500000007383831343038360000001a323031352d30372d32382031353a30383a35332e34363234393500000002323800000001740000000443505357ffffffff0000000e3ba6dc3b7d2be392fe6938e1779a4400000095000d000000044c544f560000000331333700000005302e3736330000001a313937302d30312d30312030303a30303a30302e30353030303000000005302e3838320000000439303534ffffffff0000001a323031352d30342d32302030353a30393a30332e353830353734000000033130360000000166000000045045484e0000000a323031352d30312d3039ffffffff4400000093000d000000045a494d4e00000003313235ffffffff0000001a313937302d30312d30312030303a30303a30302e303630303030ffffffff00000005313135323400000007383333353236310000001a323031352d31302d32362030323a31303a35302e363838333934000000033131310000000174000000045045484e0000000a323031352d30382d3231ffffffff4400000093000d000000044f504a4f0000000331363800000005302e3130350000001a313937302d30312d30312030303a30303a30302e30373030303000000005302e353335000000052d3539323000000007373038303730340000001a323031352d30372d31312030393a31353a33382e3334323731370000000331303300000001660000000456544a57ffffffffffffffff440000009c000d00000004474c554f0000000331343500000005302e3533390000001a313937302d30312d30312030303a30303a30302e30383030303000000005302e37363700000005313432343200000007323439393932320000001a323031352d31312d30322030393a30313a33312e3331323830340000000238340000000166000000045045484e0000000a323031352d31312d3134ffffffff44000000a9000d000000045a5651450000000331303300000005302e3637330000001a313937302d30312d30312030303a30303a30302e303930303030ffffffff00000005313337323700000007373837353834360000001a323031352d31322d31322031333a31363a32362e3133343536320000000232320000000174000000045045484e0000000a323031352d30312d323000000012143380c9eba3677a1a79e435e43adc5c65ff440000009a000d000000044c4947590000000331393900000005302e3238340000001a313937302d30312d30312030303a30303a30302e313030303030ffffffff00000005333034323600000007333231353536320000001a323031352d30382d32312031343a35353a30372e30353537323200000002313100000001660000000456544a57ffffffff0000000dff703ac78ab314cd470b0c3912440000008d000d000000044d514e5400000002343300000005302e3538360000001a313937302d30312d30312030303a30303a30302e31313030303000000005302e333335000000053237303139ffffffffffffffff0000000232370000000174000000045045484e0000000a323031352d30372d31320000001326fb2e42faf56e8f80e354b807b13257ff9aef44000000ae000d00000004575743430000000332313300000005302e3736370000001a313937302d30312d30312030303a30303a30302e31323030303000000005302e35383000000005313336343000000007343132313932330000001a323031352d30382d30362030323a32373a33302e3436393736320000000237330000000166000000045045484e0000000a323031352d30342d33300000001271a7d5af11963708dd98ef54882aa2ade7d444000000a2000d00000004564647500000000331323000000005302e3834300000001a313937302d30312d30312030303a30303a30302e31333030303000000005302e373733000000043732323300000007373234313432330000001a323031352d31322d31382030373a33323a31382e34353630323500000002343300000001660000000456544a57ffffffff00000011244e44a80dfe27ec53135db215e7b83567440000009c000d00000004524d44470000000331333400000005302e3131300000001a313937302d30312d30312030303a30303a30302e31343030303000000005302e30343300000005323132323700000007373135353730380000001a323031352d30372d30332030343a31323a34352e373734323831000000023432000000017400000004435053570000000a323031352d30322d3234ffffffff4400000098000d0000000457464f5100000003323535ffffffff0000001a313937302d30312d30312030303a30303a30302e31353030303000000005302e31313600000005333135363900000007363638383237370000001a323031352d30352d31392030333a33303a34352e373739393939000000033132360000000174000000045045484e0000000a323031352d31322d3039ffffffff440000007e000d000000044d58444b00000002353600000005312e3030300000001a313937302d30312d30312030303a30303a30302e31363030303000000005302e353233000000062d33323337320000000736383834313332ffffffff0000000235380000000166ffffffff0000000a323031352d30312d3230ffffffff44000000a1000d00000004584d4b4a0000000331333900000005302e3834310000001a313937302d30312d30312030303a30303a30302e31373030303000000005302e333036000000053235383536ffffffff0000001a323031352d30352d31382030333a35303a32322e373331343337000000013200000001740000000456544a570000000a323031352d30362d32350000000d007cfb0119caf2bf845a6f383544000000a2000d0000000456494844ffffffffffffffff0000001a313937302d30312d30312030303a30303a30302e31383030303000000005302e35353000000005323232383000000007393130393834320000001a323031352d30312d32352031333a35313a33382e323730353833000000023934000000016600000004435053570000000a323031352d31302d32370000000e2d16f389a38364ded6fdc45bc4e944000000a3000d0000000457504e58ffffffff00000005302e3934370000001a313937302d30312d30312030303a30303a30302e31393030303000000005302e343135000000062d3137393333000000063637343236310000001a323031352d30332d30342031353a34333a31352e323133363836000000023433000000017400000004485952580000000a323031352d31322d31380000000ab34c0e8ff10cc560b7d144000000a3000d0000000459504f5600000002333600000005302e3637340000001a313937302d30312d30312030303a30303a30302e32303030303000000005302e303331000000052d3538383800000007313337353432330000001a323031352d31322d31302032303a35303a33352e38363636313400000001330000000174ffffffff0000000a323031352d30372d32330000000dd4abbe30fa8dac3d98a0ad9a5d44000000ac000d000000044e55484effffffff00000005302e3639340000001a313937302d30312d30312030303a30303a30302e32313030303000000005302e333339000000062d323532323600000007333532343734380000001a323031352d30352d30372030343a30373a31382e31353239363800000002333900000001740000000456544a570000000a323031352d30342d303400000012b8bef8a146872892a39be3cbc2648ab035d8440000008e000d00000004424f53450000000332343000000005302e3036300000001a313937302d30312d30312030303a30303a30302e32323030303000000005302e33373900000005323339303400000007393036393333390000001a323031352d30332d32312030333a34323a34322e3634333138360000000238340000000174ffffffffffffffffffffffff44000000ab000d00000004494e4b470000000331323400000005302e3836320000001a313937302d30312d30312030303a30303a30302e32333030303000000005302e343034000000062d333033383300000007373233333534320000001a323031352d30372d32312031363a34323a34372e3031323134380000000239390000000166ffffffff0000000a323031352d30382d32370000001287fc9283fc88f3322770c801b0dcc93a5b7e4400000097000d000000044655584300000002353200000005302e3734330000001a313937302d30312d30312030303a30303a30302e323430303030ffffffff000000062d313437323900000007313034323036340000001a323031352d30382d32312030323a31303a35382e393439363734000000023238000000017400000004435053570000000a323031352d30382d3239ffffffff44000000a4000d00000004554e595100000002373100000005302e3434320000001a313937302d30312d30312030303a30303a30302e32353030303000000005302e353339000000062d3232363131ffffffff0000001a323031352d31322d32332031383a34313a34322e3331393835390000000239380000000174000000045045484e0000000a323031352d30312d32360000000f28ed9799d877333fb267da984747bf4400000096000d000000044b424d51ffffffff00000005302e3238300000001a313937302d30312d30312030303a30303a30302e323630303030ffffffff000000053132323430ffffffff0000001a323031352d30382d31362030313a30323a35352e3736363632320000000232310000000166ffffffff0000000a323031352d30352d31390000000d6ade4604d381e7a21622353b1c4400000084000d000000044a534f4c00000003323433ffffffff0000001a313937302d30312d30312030303a30303a30302e32373030303000000005302e303638000000062d3137343638ffffffffffffffff0000000232300000000174ffffffff0000000a323031352d30362d3139000000113de02d0486e7ca29980769ca5bd6cf0969440000007f000d00000004484e535300000003313530ffffffff0000001a313937302d30312d30312030303a30303a30302e32383030303000000005302e3134380000000531343834310000000735393932343433ffffffff0000000232350000000166000000045045484effffffff0000000c14d6fcee032281b806c406af44000000a7000d00000004505a50420000000331303100000005302e3036320000001a313937302d30312d30312030303a30303a30302e323930303030ffffffff00000005313232333700000007393837383137390000001a323031352d30392d30332032323a31333a31382e38353234363500000002373900000001660000000456544a570000000a323031352d31322d31370000001012613a9aad982e7552ad62878845b99d44000000a9000d000000044f594e4e00000002323500000005302e3333390000001a313937302d30312d30312030303a30303a30302e33303030303000000005302e36323800000005323234313200000007343733363337380000001a323031352d31302d31302031323a31393a34322e35323832323400000003313036000000017400000004435053570000000a323031352d30372d30310000000d54133fffb67ecd0427669489db4400000076000dffffffff0000000331313700000005302e3536340000001a313937302d30312d30312030303a30303a30302e333130303030ffffffff000000052d353630340000000736333533303138ffffffff0000000238340000000166ffffffffffffffff0000000b2bad2507db6244336e008e440000007e000d00000004485652490000000332333300000005302e3232340000001a313937302d30312d30312030303a30303a30302e33323030303000000005302e3432350000000531303436390000000731373135323133ffffffff0000000238360000000166ffffffff0000000a323031352d30322d3032ffffffff440000009c000d000000044f59544f00000002393600000005302e3734310000001a313937302d30312d30312030303a30303a30302e33333030303000000005302e353238000000062d313232333900000007333439393632300000001a323031352d30322d30372032323a33353a30332e3231323236380000000231370000000166000000045045484e0000000a323031352d30332d3239ffffffff440000008b000d000000044c46435900000002363300000005302e3732320000001a313937302d30312d30312030303a30303a30302e333430303030ffffffff0000000532333334340000000739353233393832ffffffff00000003313233000000016600000004435053570000000a323031352d30352d31380000000e05e5c04eccd6e37b34cd1535bba444000000a7000d0000000447484c580000000331343800000005302e3330360000001a313937302d30312d30312030303a30303a30302e33353030303000000005302e363336000000062d333134353700000007323332323333370000001a323031352d31302d32322031323a30363a30352e353434373031000000023931000000017400000004485952580000000a323031352d30352d32310000000a571d91723004b702cb034400000097000d000000045954535a00000003313233ffffffff0000001a313937302d30312d30312030303a30303a30302e33363030303000000005302e35313900000005323235333400000007343434363233360000001a323031352d30372d32372030373a32333a33372e323333373131000000023533000000016600000004435053570000000a323031352d30312d3133ffffffff4400000096000d0000000453574c5500000003323531ffffffff0000001a313937302d30312d30312030303a30303a30302e33373030303000000005302e313739000000043737333400000007343038323437350000001a323031352d31302d32312031383a32343a33342e3430303334350000000236390000000166000000045045484e0000000a323031352d30342d3031ffffffff44000000a4000d0000000454514a4c00000003323435ffffffff0000001a313937302d30312d30312030303a30303a30302e33383030303000000005302e3836350000000439353136000000063932393334300000001a323031352d30352d32382030343a31383a31382e36343035363700000002363900000001660000000456544a570000000a323031352d30362d31320000000f6c3e51d7ebb10771321faf404e8c474400000091000d000000045245494a000000023934ffffffff0000001a313937302d30312d30312030303a30303a30302e33393030303000000005302e313330000000062d3239393234ffffffff0000001a323031352d30332d32302032323a31343a34362e32303437313800000003313133000000017400000004485952580000000a323031352d31322d3139ffffffff44000000a8000d000000044844485100000002393400000005302e3732330000001a313937302d30312d30312030303a30303a30302e34303030303000000005302e373330000000053139393730000000063635343133310000001a323031352d30312d31302032323a35363a30382e3438303435300000000238340000000174ffffffff0000000a323031352d30332d3035000000124f566b65a45338e9cdc1a7ee8675ada52d49440000009c000d00000004554d455500000002343000000005302e3030380000001a313937302d30312d30312030303a30303a30302e34313030303000000005302e383035000000062d313136323300000007343539393836320000001a323031352d31312d32302030343a30323a34342e3333353934370000000237360000000166000000045045484e0000000a323031352d30352d3137ffffffff44000000a0000d00000004594a494800000003313834ffffffff0000001a313937302d30312d30312030303a30303a30302e34323030303000000005302e33383300000005313736313400000007333130313637310000001a323031352d30312d32382031323a30353a34362e363833303031000000033130350000000174ffffffff0000000a323031352d31322d30370000000cec69cd73bb9bc595db6191ce4400000089000d000000044359584700000002323700000005302e3239320000001a313937302d30312d30312030303a30303a30302e34333030303000000005302e393533000000043339343400000006323439313635ffffffff0000000236370000000174ffffffff0000000a323031352d30332d30320000000e0148153e0c7f3f8fe4b5ab3421294400000099000d000000044d5254470000000331343300000005302e3032360000001a313937302d30312d30312030303a30303a30302e34343030303000000005302e393433000000062d323733323000000007313636373834320000001a323031352d30312d32342031393a35363a31352e3937333130390000000231310000000166ffffffff0000000a323031352d30312d3234ffffffff44000000aa000d00000004444f4e500000000332343600000005302e3635340000001a313937302d30312d30312030303a30303a30302e34353030303000000005302e35353600000005323734373700000007343136303031380000001a323031352d31322d31342030333a34303a30352e3931313833390000000232300000000174000000045045484e0000000a323031352d31302d32390000000e079201f56aa131cdcbc2a2b48e9944000000a9000d00000004495158530000000332333200000005302e3233310000001a313937302d30312d30312030303a30303a30302e34363030303000000005302e303439000000062d313831313300000007343030353232380000001a323031352d30362d31312031333a30303a30372e3234383138380000000138000000017400000004435053570000000a323031352d30382d31360000000dfa1f9224b1b8676508b7f8410044000000a4000dffffffff00000003313738ffffffff0000001a313937302d30312d30312030303a30303a30302e34373030303000000005302e393033000000062d313436323600000007323933343537300000001a323031352d30342d30342030383a35313a35342e3036383135340000000238380000000174ffffffff0000000a323031352d30372d303100000014843625632b6361431c477db646babb98ca08bea44400000097000d000000044855575a00000002393400000005302e3131300000001a313937302d30312d30312030303a30303a30302e34383030303000000005302e343230000000052d3337333600000007353638373531340000001a323031352d30312d30322031373a31383a30352e3632373633330000000237340000000166ffffffff0000000a323031352d30332d3239ffffffff440000009d000d000000045352454400000002363600000005302e3131330000001a313937302d30312d30312030303a30303a30302e34393030303000000005302e303630000000062d313035343300000007333636393337370000001a323031352d31302d32322030323a35333a30322e3338313335310000000237370000000174000000045045484effffffff0000000b7c3fd6883a93ef24a5e2bc\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                ">420000000c000000000000000044000000065000450000000900000000005300000004440000000650004500000009000000000053000000044500000009000000000053000000045300000004\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n" +
                "<44000000a8000d0000000450574c5a00000002393100000005302e3530340000001a313937302d30312d30312030303a30303a30302e303030303030ffffffff000000052d3739383500000007343233343632310000001a323031352d30312d32362031323a31373a31302e363535353938000000033130360000000166000000045045484e0000000a323031352d31322d3036000000112a4e91c5e439b2dd0da7bbd57172ba9cac440000008f000d00000004594c58470000000331313400000005302e3739320000001a313937302d30312d30312030303a30303a30302e303130303030ffffffff0000000531383230300000000737363830303832ffffffff000000023530000000017400000004435053570000000a323031352d30352d31330000001252bb50c9024d40ef1fb817f741ffc1a75cc34400000092000d00000004424b5850ffffffff00000005302e3735360000001a313937302d30312d30312030303a30303a30302e30323030303000000005302e393030000000062d3136393636ffffffff0000001a323031352d30372d30382030343a30393a30372e3132373837340000000135000000017400000004485952580000000a323031352d31302d3132ffffffff4400000096000d00000004485844420000000332333900000005302e3433340000001a313937302d30312d30312030303a30303a30302e30333030303000000005302e323335000000053235363238ffffffff0000001a323031352d30392d32302031383a30313a35362e37313437363800000003313134000000017400000004485952580000000a323031352d31312d3039ffffffff440000009d000d0000000454534c4f0000000331353800000005302e3035380000001a313937302d30312d30312030303a30303a30302e30343030303000000005302e333933000000062d313736363900000007373435393639300000001a323031352d31302d30372030303a32393a35372e353439393139000000023333000000016600000004485952580000000a323031352d30342d3038ffffffff4400000090000d00000004484a5558000000013800000005302e3137360000001a313937302d30312d30312030303a30303a30302e30353030303000000005302e31353500000005323530353700000007383334313835310000001a323031352d30322d30382030333a33333a34342e35353434373300000002383300000001660000000456544a57ffffffffffffffff44000000ab000d00000004535444540000000331303600000005302e3231390000001a313937302d30312d30312030303a30303a30302e30363030303000000005302e37373700000005323238383300000007353136383237310000001a323031352d31322d32392030353a30303a33392e3139373135310000000331323500000001740000000456544a570000000a323031352d30392d32350000000e66ca8556e244dbb8e993fcd9cb994400000090000d000000044d43495900000002323600000005302e3138390000001a313937302d30312d30312030303a30303a30302e30373030303000000005302e373535000000062d3231363334ffffffff0000001a323031352d31312d31342031373a34313a31382e38393931363900000001320000000174ffffffff0000000a323031352d30372d3134ffffffff440000009b000d000000044b53514400000002353100000005302e3238360000001a313937302d30312d30312030303a30303a30302e30383030303000000005302e323837000000053139313433ffffffff0000001a323031352d30372d31362030383a33363a35372e373737393837000000033132300000000174ffffffff0000000a323031352d30342d30360000000a84d512fb719934038208440000009d000d000000044a4a46470000000332313100000005302e3832320000001a313937302d30312d30312030303a30303a30302e30393030303000000005302e323735000000062d313831353700000007393639323732300000001a323031352d30352d32332030383a34303a33332e3431393237370000000231320000000174000000045045484e0000000a323031352d30372d3036ffffffff44000000a7000d0000000449584d490000000331313200000005302e3334370000001a313937302d30312d30312030303a30303a30302e31303030303000000005302e363537000000062d313930313700000007393630313134370000001a323031352d31302d30342030363a32323a31322e383039353930000000023737000000017400000004435053570000000a323031352d30342d32300000000a1a275b4d0f33f470bb5744000000a4000d0000000445464a420000000331393900000005302e3537360000001a313937302d30312d30312030303a30303a30302e31313030303000000005302e343330000000043530353900000007353031303134340000001a323031352d30332d30392031373a33343a34372e3631393630320000000233320000000174ffffffff0000000a323031352d30342d31350000000d003aea50240bc51a5a8d8550394400000097000d000000044a46424b0000000331333900000005302e3236350000001a313937302d30312d30312030303a30303a30302e31323030303000000005302e313832000000043332353500000007333732343636300000001a323031352d31322d31302031353a35363a32352e3535383733350000000239350000000174ffffffff0000000a323031352d30362d3131ffffffff440000009f000d000000044d44524e0000000331303600000005302e3136340000001a313937302d30312d30312030303a30303a30302e31333030303000000005302e343734000000062d3138383439000000063638343236390000001a323031352d31322d32382032303a35383a32362e30333732343400000002313900000001660000000448595258ffffffff0000000d39dc8c6c6bac60aabcf427617844000000a3000d000000045650474800000002343200000005302e3530330000001a313937302d30312d30312030303a30303a30302e31343030303000000005302e323033000000062d313537323000000007353837303336380000001a323031352d30352d32392030373a30363a33302e3337373730360000000234340000000174ffffffff0000000a323031352d30372d30310000000bd989264fe4513785e1e46e440000008d000d000000044f54485300000002373400000005302e3232340000001a313937302d30312d30312030303a30303a30302e31353030303000000005302e31313600000004393832310000000733393533393634ffffffff000000023132000000017400000004435053570000000a323031352d30322d30320000000d593e98c98e5fbd124072694ec244000000a3000d000000044e4746440000000134ffffffff0000001a313937302d30312d30312030303a30303a30302e31363030303000000005302e32363600000005313731353400000007323532343534320000001a323031352d30322d32322030393a33353a30362e36363236333500000001380000000174ffffffff0000000a323031352d31312d303200000013983fb81e53a335588dca1dd0b2eb543f32825b4400000091000d000000045151444f00000002313000000005302e3635330000001a313937302d30312d30312030303a30303a30302e31373030303000000005302e323533000000052d3132313200000007333437363834330000001a323031352d30312d32352032333a31393a34352e32343533373200000002343300000001660000000448595258ffffffffffffffff44000000aa000d00000004534f42520000000331333200000005302e3932350000001a313937302d30312d30312030303a30303a30302e31383030303000000005302e343334000000042d38343600000007333632383332300000001a323031352d30372d32372031373a32393a32342e303037373235000000023335000000016600000004435053570000000a323031352d30322d30370000000f66a1f432e1d00dbf2e91a04aa8bc1c44000000ab000d00000004554452450000000331303700000005302e3939370000001a313937302d30312d30312030303a30303a30302e31393030303000000005302e38353700000005313633383200000007343932313737350000001a323031352d30332d30382031303a35313a32322e303139353234000000023830000000016600000004485952580000000a323031352d31302d33300000000f671cfdeba385e53d2184bbb19b5da544000000aa000d0000000457424e450000000331323700000005302e3534350000001a313937302d30312d30312030303a30303a30302e32303030303000000005302e34303300000005313232353100000007383033333232330000001a323031352d30362d31362032313a30363a33312e3735303434310000000236300000000174ffffffff0000000a323031352d31322d303500000012c555ef19d90f612db25ad879a0b0ac6093f1440000007a000dffffffff0000000331393400000005302e3435330000001a313937302d30312d30312030303a30303a30302e323130303030ffffffff000000062d32363936380000000738373030363431ffffffff0000000234300000000174000000045045484e0000000a323031352d31322d3037ffffffff440000009e000d0000000447445450ffffffff00000005302e3232370000001a313937302d30312d30312030303a30303a30302e32323030303000000005302e343436000000062d333030393000000007323736323737390000001a323031352d31322d31322030333a35383a35302e38373830313500000002313100000001660000000456544a57ffffffff0000000e6b531e18079d752a1131d2fbde75440000008f000d00000004575a434a0000000332343400000005302e3937350000001a313937302d30312d30312030303a30303a30302e32333030303000000005302e3232320000000532353836360000000731343830363238ffffffff000000023330000000016600000004485952580000000a323031352d30312d32310000000d4b9d2a9fc1f84f032a59d613dd44000000ae000d000000044f5854500000000331393200000005302e3935370000001a313937302d30312d30312030303a30303a30302e32343030303000000005302e30393400000005323330363000000007333431303232300000001a323031352d30322d32352031373a32313a34342e393532383735000000023137000000017400000004485952580000000a323031352d31312d323300000012fcbb7bd33f08bfbfc083960994535679ebcd44000000a2000d000000044b5859440000000331353100000005302e3430300000001a313937302d30312d30312030303a30303a30302e32353030303000000005302e373534000000062d313833373000000007383236323230360000001a323031352d30342d31392031323a33373a30392e3538383935370000000231390000000166ffffffffffffffff0000001329b39aab7e35973ea15a97c402793839c148ef44000000ad000d00000004574d53520000000331393800000005302e3236350000001a313937302d30312d30312030303a30303a30302e32363030303000000005302e33333100000005313935303100000007373630303133310000001a323031352d31322d30382031363a34383a32352e333633353233000000033132330000000174ffffffff0000000a323031352d30382d303300000014d1df4c3da99136abd2ce1b77497791c2b8f4e7c94400000097000dffffffff0000000331333400000005302e3136320000001a313937302d30312d30312030303a30303a30302e32373030303000000005302e35323300000005323037373100000007323738343235380000001a323031352d31312d31372031353a31343a32312e31323236343700000001310000000174000000045045484e0000000a323031352d31322d3038ffffffff44000000a7000d00000004434c47450000000332343000000005302e3639330000001a313937302d30312d30312030303a30303a30302e32383030303000000005302e35353400000005313839393700000007313239353535300000001a323031352d30332d31322031353a34343a33372e3139353039370000000234310000000166000000045045484e0000000a323031352d30352d30390000000bf6eeea3fc2953f27ede8c044000000b0000d000000045843464f0000000332333100000005302e3335330000001a313937302d30312d30312030303a30303a30302e32393030303000000005302e39353400000005333133333100000007383239343437380000001a323031352d31302d32382032323a35313a31392e36383232313700000003313134000000016600000004485952580000000a323031352d30342d3031000000131e60f2343a5e725d5a66734923034956bd02aa44000000a1000d0000000459515953000000013600000005302e3034350000001a313937302d30312d30312030303a30303a30302e33303030303000000005302e37333200000005333139313700000007343636313037350000001a323031352d30362d31372030333a34333a33322e333937323233000000033131350000000166ffffffff0000000a323031352d31322d31320000000a60a87e6ca44f9dab2b61440000009d000d000000044b4a4b4e0000000332323100000005302e3639330000001a313937302d30312d30312030303a30303a30302e33313030303000000005302e393832000000062d333234373900000007313538373835320000001a323031352d30392d30342031303a33393a35332e36313236343200000002323300000001740000000456544a570000000a323031352d31322d3236ffffffff4400000095000d00000004485a4d440000000332333600000005302e3233310000001a313937302d30312d30312030303a30303a30302e33323030303000000005302e323835000000053237393932ffffffff0000001a323031352d30382d31382031343a32323a30352e383334313532000000023231000000017400000004485952580000000a323031352d30342d3036ffffffff4400000093000dffffffff00000003323139ffffffff0000001a313937302d30312d30312030303a30303a30302e33333030303000000005302e373138000000052d3236393700000007383132303236360000001a323031352d31312d30382031383a31373a33322e3336323935330000000235390000000166000000045045484effffffff0000000a40f24f2981d070ecd5f344000000a4000d00000004585a4d4d0000000332343600000005302e3436300000001a313937302d30312d30312030303a30303a30302e33343030303000000005302e3937320000000438323635000000063936333230390000001a323031352d30312d32322031343a35363a34352e343936303139000000033132360000000174ffffffff0000000a323031352d30322d31390000000d2738e2f83774df3ad8e1e6ba4a44000000a8000d000000044355465700000002363700000005302e3837310000001a313937302d30312d30312030303a30303a30302e33353030303000000005302e3233350000000331323500000007383037343433360000001a323031352d30392d32392030353a31303a35332e343037303834000000023937000000017400000004485952580000000a323031352d30312d30340000000f568acf3f12ab0f4ddf7eb106d30b1a44000000a8000d000000045642575a0000000332333800000005302e3832310000001a313937302d30312d30312030303a30303a30302e33363030303000000005302e30393200000005323634383700000007323535393938320000001a323031352d30372d33302030323a35343a33302e3836353137340000000235320000000166000000045045484e0000000a323031352d30312d30350000000cfb04dc12a5f0054cebaf228c4400000089000dffffffff0000000331393000000005302e3834320000001a313937302d30312d30312030303a30303a30302e33373030303000000005302e363537000000062d313831333100000006333034323135ffffffff0000000236380000000174000000045045484e0000000a323031352d30362d30380000000b40808e49636de05a311bea4400000098000d00000004454d50500000000332333600000005302e3537350000001a313937302d30312d30312030303a30303a30302e333830303030ffffffff000000062d323939353600000007363033333235390000001a323031352d30372d31362031353a35303a35372e36333133313700000002353300000001740000000456544a570000000a323031352d30352d3137ffffffff4400000094000d000000045a4b585000000002343000000005302e3235320000001a313937302d30312d30312030303a30303a30302e33393030303000000005302e303133000000053332363530ffffffff0000001a323031352d30372d31362031333a31333a34392e353038343632000000023933000000017400000004485952580000000a323031352d30392d3232ffffffff44000000a5000d00000004464d4453000000013500000005302e3631370000001a313937302d30312d30312030303a30303a30302e34303030303000000005302e31313200000005313039303900000007323734363639360000001a323031352d30382d32322032313a32333a31352e3436383933300000000237380000000174000000045045484e0000000a323031352d30352d30330000000b48f5da38103592256a3b964400000092000d00000004495456580000000331393700000005302e3939370000001a313937302d30312d30312030303a30303a30302e34313030303000000005302e393438000000052d3638353100000007353334343533330000001a323031352d30362d32382032323a32373a32322e39303431353700000002353900000001740000000456544a57ffffffffffffffff44000000a4000dffffffff00000002383100000005302e3331380000001a313937302d30312d30312030303a30303a30302e34323030303000000005302e34373600000005313333313400000007383232353535320000001a323031352d30312d31332030333a34333a32352e33313539303800000001370000000166000000045045484e0000000a323031352d30372d31330000000e68d74fc2ca1ad35d9f47589c57204400000098000d00000004544c594d00000002363100000005302e3735380000001a313937302d30312d30312030303a30303a30302e34333030303000000005302e303139000000062d323531363000000007383832303338360000001a323031352d30342d31362031373a35343a32332e3631343634360000000235380000000174ffffffff0000000a323031352d31302d3138ffffffff4400000087000d00000004514d494f000000023634ffffffff0000001a313937302d30312d30312030303a30303a30302e34343030303000000005302e343131000000062d31393730340000000738323130383932ffffffff0000000233340000000166ffffffff0000000a323031352d30372d31330000000efb08dddaaad2d5bab2d190e1692b4400000092000d000000044246435500000002313400000005302e3332390000001a313937302d30312d30312030303a30303a30302e34353030303000000005302e323631000000062d31363631390000000738373733323737ffffffff0000000231370000000174000000045045484e0000000a323031352d30322d323700000010489e307c3fb023e5f9a90b86ebce31ff440000009c000d00000004524a495900000002313400000005302e3539320000001a313937302d30312d30312030303a30303a30302e34363030303000000005302e363936000000062d323932373900000007363430393031330000001a323031352d31302d33302031333a34393a33362e323031353135000000023836000000016600000004435053570000000a323031352d30312d3035ffffffff440000009e000d000000044a4e4c560000000332303600000005302e3736360000001a313937302d30312d30312030303a30303a30302e34373030303000000005302e343830000000062d313630373700000007313937313433320000001a323031352d30392d31342031353a32343a32342e35393635303700000003313235000000016600000004485952580000000a323031352d30382d3039ffffffff44000000a8000d000000044858584e0000000331373300000005302e3737320000001a313937302d30312d30312030303a30303a30302e343830303030ffffffff00000005313535303400000007313434303033340000001a323031352d30372d30352032323a31323a35352e363633313439000000033131380000000174000000045045484e0000000a323031352d30362d313500000010870211f5bb0cc5754c7697120eed2c174400000082000d000000045358514500000002383600000005302e3335360000001a313937302d30312d30312030303a30303a30302e34393030303000000005302e343238000000062d31303232310000000732353634363235ffffffff0000000238390000000166000000045045484e0000000a323031352d31302d3038ffffffff\n" +
                "<430000000f53454c45435420302030005a0000000549\n" +
                "<5400000128000d730000000000000000000413000000000000000069000000000000000000001700000000000000006400000000000000000002bd00000000000000007400000000000000000004a000000000000000006600000000000000000002bc00000000000000005f73686f7274000000000000000000001500000000000000006c0000000000000000000014000000000000000074733200000000000000000004a000000000000000006262000000000000000000001500000000000000006200000000000000000000100000000000000000726e645f73796d626f6c00000000000000000004130000000000000000726e645f64617465000000000000000000043a0000000000000000726e645f62696e00000000000000000000110000000000000001\n";

        assertHexScript(script);
    }

    @Test
    public void testSqlSyntaxError() throws SQLException, InterruptedException, BrokenBarrierException {

        final CountDownLatch haltLatch = new CountDownLatch(1);
        final AtomicBoolean running = new AtomicBoolean(true);
        try {
            startBasicServer(
                    NetworkFacadeImpl.INSTANCE,
                    new DefaultWireParserConfiguration(),
                    haltLatch,
                    running
            );

            Properties properties = new Properties();
            properties.setProperty("user", "xyz");
            properties.setProperty("password", "oh");
            properties.setProperty("sslmode", "disable");

            final Connection connection = DriverManager.getConnection("jdbc:postgresql://127.0.0.1:9120/nabu_app", properties);
            PreparedStatement statement = connection.prepareStatement("create table x");
            try {
                statement.execute();
                Assert.fail();
            } catch (SQLException e) {
                Assert.assertTrue(e instanceof PSQLException);
                PSQLException pe = (PSQLException) e;
                Assert.assertEquals(14, pe.getServerErrorMessage().getPosition());
                Assert.assertEquals("'(' or 'as' expected", pe.getServerErrorMessage().getMessage());
            }
            statement.close();
            connection.close();
        } finally {
            running.set(false);
            haltLatch.await();
        }
    }

    private void assertHexScript(String script) throws Exception {
        assertHexScript(NetworkFacadeImpl.INSTANCE, NetworkFacadeImpl.INSTANCE, script, new DefaultWireParserConfiguration());
    }

    private void assertHexScript(
            NetworkFacade clientNf,
            NetworkFacade serverNf,
            String script,
            WireParserConfiguration wireParserConfiguration
    ) throws Exception {
        TestUtils.assertMemoryLeak(() -> {
            final CountDownLatch haltLatch = new CountDownLatch(1);
            final AtomicBoolean running = new AtomicBoolean(true);
            try {
                startBasicServer(
                        serverNf,
                        wireParserConfiguration,
                        haltLatch,
                        running
                );

                long clientFd = clientNf.socketTcp(true);
                long sockAddress = clientNf.sockaddr(Net.parseIPv4("127.0.0.1"), 9120);
                Assert.assertEquals(0, clientNf.connect(clientFd, sockAddress));

                final int N = 1024 * 1024;
                final long sendBuf = Unsafe.malloc(N);
                final long recvBuf = Unsafe.malloc(N);

                try {
                    long sendPtr = sendBuf;

                    int mode = 0;
                    int n = script.length();
                    int i = 0;
                    while (i < n) {
                        char c1 = script.charAt(i);
                        switch (c1) {
                            case '<':
                            case '>':
                                int len = (int) (sendPtr - sendBuf);
                                if (mode == 0) {
                                    // we were sending - lets wrap up and send
                                    if (len > 0) {
                                        int m = clientNf.send(clientFd, sendBuf, len);
                                        Assert.assertEquals(len, m);
                                        sendPtr = sendBuf;
                                    }
                                } else {
                                    // we meant to receive; sendBuf will contain expected bytes we have to receive
                                    // and this buffer will also drive the length of the message
                                    if (len > 0) {
                                        int m = clientNf.recv(clientFd, recvBuf, len);
                                        Assert.assertEquals(len, m);
                                        for (int j = 0; j < len; j++) {
                                            Assert.assertEquals(
                                                    Unsafe.getUnsafe().getByte(sendBuf + j),
                                                    Unsafe.getUnsafe().getByte(recvBuf + j)
                                            );
                                        }
                                        // clear sendBuf
                                        sendPtr = sendBuf;
                                    }
                                }

                                if (c1 == '<') {
                                    mode = 1;
                                } else {
                                    mode = 0;
                                }
                                i++;
                                continue;
                            case '\n':
                                i++;
                                continue;
                            default:
                                char c2 = script.charAt(i + 1);
                                byte b = (byte) ((Numbers.hexToDecimal(c1) << 4) | Numbers.hexToDecimal(c2));
                                Unsafe.getUnsafe().putByte(sendPtr++, b);
                                i += 2;
                                break;
                        }
                    }
                } finally {
                    Unsafe.free(sendBuf, N);
                    Unsafe.free(recvBuf, N);
                    clientNf.freeSockAddr(sockAddress);
                    clientNf.close(clientFd);
                }
            } catch (Throwable e) {
                e.printStackTrace();
            } finally {
                running.set(false);
                haltLatch.await();
            }
        });
    }

    private void startBasicServer(
            NetworkFacade nf,
            WireParserConfiguration configuration,
            CountDownLatch haltLatch,
            AtomicBoolean running
    ) throws BrokenBarrierException, InterruptedException {
        final CyclicBarrier barrier = new CyclicBarrier(2);
        new Thread(() -> {
            long fd = Net.socketTcp(true);
            try {

                nf.setReusePort(fd);
                nf.configureNoLinger(fd);

                Assert.assertTrue(nf.bindTcp(fd, 0, 9120));
                nf.listen(fd, 128);

                LOG.info().$("listening [fd=").$(fd).$(']').$();

                try (WireParser wireParser = new WireParser(configuration, engine)) {
                    SharedRandom.RANDOM.set(new Rnd());
                    try {
                        barrier.await();
                    } catch (InterruptedException | BrokenBarrierException e) {
                        e.printStackTrace();
                    }
                    final long clientFd = Net.accept(fd);
                    nf.configureNonBlocking(clientFd);
                    LOG.info().$("connected [clientFd=").$(clientFd).$(']').$();
                    while (running.get()) {
                        try {
                            wireParser.process(clientFd);
                        } catch (PeerDisconnectedException e) {
                            break;
                        } catch (PeerIsSlowToReadException | PeerIsSlowToWriteException ignored) {
                        }
                    }
                    nf.close(clientFd);
                }
            } finally {
                nf.close(fd);
                haltLatch.countDown();
                LOG.info().$("done").$();
            }
        }).start();
        barrier.await();
    }

    private void assertResultSet(String expected, StringSink sink, ResultSet rs) throws SQLException, IOException {
        // dump metadata
        ResultSetMetaData metaData = rs.getMetaData();
        final int columnCount = metaData.getColumnCount();
        for (int i = 0; i < columnCount; i++) {
            if (i > 0) {
                sink.put(',');
            }

            sink.put(metaData.getColumnName(i + 1));
            sink.put('[').put(JDBCType.valueOf(metaData.getColumnType(i + 1)).name()).put(']');
        }
        sink.put('\n');

        while (rs.next()) {
            for (int i = 1; i <= columnCount; i++) {
                if (i > 1) {
                    sink.put(',');
                }
                switch (JDBCType.valueOf(metaData.getColumnType(i))) {
                    case VARCHAR:
                        String stringValue = rs.getString(i);
                        if (rs.wasNull()) {
                            sink.put("null");
                        } else {
                            sink.put(stringValue);
                        }
                        break;
                    case INTEGER:
                        int intValue = rs.getInt(i);
                        if (rs.wasNull()) {
                            sink.put("null");
                        } else {
                            sink.put(intValue);
                        }
                        break;
                    case DOUBLE:
                        double doubleValue = rs.getDouble(i);
                        if (rs.wasNull()) {
                            sink.put("null");
                        } else {
                            sink.put(doubleValue, 8);
                        }
                        break;
                    case TIMESTAMP:
                        Timestamp timestamp = rs.getTimestamp(i);
                        if (timestamp == null) {
                            sink.put("null");
                        } else {
                            sink.put(timestamp.toString());
                        }
                        break;
                    case REAL:
                        double floatValue = rs.getFloat(i);
                        if (rs.wasNull()) {
                            sink.put("null");
                        } else {
                            sink.put(floatValue, 4);
                        }
                        break;
                    case SMALLINT:
                        sink.put(rs.getShort(i));
                        break;
                    case BIGINT:
                        long longValue = rs.getLong(i);
                        if (rs.wasNull()) {
                            sink.put("null");
                        } else {
                            sink.put(longValue);
                        }
                        break;
                    case BIT:
                        sink.put(rs.getBoolean(i));
                        break;
                    case DATE:
                        Date date = rs.getDate(i);
                        if (date == null) {
                            sink.put("null");
                        } else {
                            sink.put(date.toString());
                        }
                        break;
                    case BINARY:
                        InputStream stream = rs.getBinaryStream(i);
                        if (stream == null) {
                            sink.put("null");
                        } else {
                            toSink(stream, sink);
                        }
                        break;
                }
            }
            sink.put('\n');
        }

        TestUtils.assertEquals(expected, sink);
    }

}