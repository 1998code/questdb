/*******************************************************************************
 *  _  _ ___ ___     _ _
 * | \| | __/ __| __| | |__
 * | .` | _|\__ \/ _` | '_ \
 * |_|\_|_| |___/\__,_|_.__/
 *
 * Copyright (C) 2014-2016 Appsicle
 *
 * This program is free software: you can redistribute it and/or  modify
 * it under the terms of the GNU Affero General Public License, version 3,
 * as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * As a special exception, the copyright holders give permission to link the
 * code of portions of this program with the OpenSSL library under certain
 * conditions as described in each individual source file and distribute
 * linked combinations including the program with the OpenSSL library. You
 * must comply with the GNU Affero General Public License in all respects for
 * all of the code used other than as permitted herein. If you modify file(s)
 * with this exception, you may extend this exception to your version of the
 * file(s), but you are not obligated to do so. If you do not wish to do so,
 * delete this exception statement from your version. If you delete this
 * exception statement from all source files in the program, then also delete
 * it in the license file.
 *
 ******************************************************************************/

"use strict";function s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return s4()+s4()+"-"+s4()+"-"+s4()+"-"+s4()+"-"+s4()+s4()+s4()}function toSize(e){return 1024>e?e:1048576>e?Math.round(e/1024)+"KB":1073741824>e?Math.round(e/1024/1024)+"MB":Math.round(e/1024/1024/1024)+"GB"}function nopropagation(e){e.stopPropagation(),e.preventDefault&&e.preventDefault()}function localStorageSupport(){return"localStorage"in window&&null!==window.localStorage}function fixHeight(){var e=$("body > #wrapper").height()-61;$(".sidebard-panel").css("min-height",e+"px");var t=$("nav.navbar-default").height(),n=$("#page-wrapper"),a=n.height();t>a&&n.css("min-height",t+"px"),a>t&&n.css("min-height",$(window).height()+"px"),$("body").hasClass("fixed-nav")&&(t>a?n.css("min-height",t-60+"px"):n.css("min-height",$(window).height()-60+"px"))}!function(e){e.fn.importManager=function(){function t(t){if(t.lengthComputable){var n=t.loaded||t.position;e("#"+O.id).find(" > .ud-progress").css("width",100*n/O.size+"%")}}function n(){var t=!1,n=!1;for(var a in k)if(k.hasOwnProperty(a)){var i=k[a];if(i.selected&&(t=!0,i.retry)){n=!0;break}}e("#btnImportClearSelected").attr("disabled",!t),e("#btnRetry").attr("disabled",!n)}function a(t,a){var i=k[a];i.retry=2,e("#"+a+" > .ud-c1").html(i.name+'<span class="label label-danger m-l-lg">overwrite</span>'),n()}function i(t,a){var i=k[a];i.retry=1,e("#"+a+" > .ud-c1").html(i.name+'<span class="label label-primary m-l-lg">append</span>'),n()}function s(t,a){var i=k[a];i.retry=0,e("#"+a+" > .ud-c1").html(i.name),n()}function o(){var n=e.ajaxSettings.xhr();return n.upload&&n.upload.addEventListener("progress",t,!1),n}function r(){e("#btnImportCancel").attr("disabled",null===O)}function l(){var t=e(this).parent().attr("id"),a=e("#"+t).find(".fa"),i=k[t];i.selected=!i.selected,i.selected?a.removeClass("fa-square-o").addClass("fa-check-square-o"):a.removeClass("fa-check-square-o").addClass("fa-square-o"),n()}function d(t){var n=k[e(this).parent().attr("id")];n.importState>-1&&e(document).trigger("import.detail",n),nopropagation(t)}function c(t){T.append('<div id="'+t.id+'" class="ud-row" style="top: '+I+'px;"><div class="ud-cell ud-c0"><i class="fa fa-square-o ud-checkbox"></i></div><div class="ud-cell ud-c1">'+t.name+'</div><div class="ud-cell ud-c2">'+t.sizeFmt+'</div><div class="ud-cell ud-c3"><span class="label">pending</span></div></div>');var n=e("#"+t.id);n.find(".ud-c0").click(l),n.find(".ud-c1").click(d),n.find(".ud-c2").click(d),n.find(".ud-c3").click(d),I+=q}function u(t,n,a){var i=e("#"+t.id);if(i.find(" > .ud-c3").html(n),i.find(" > .ud-progress").remove(),a){var s=E.shift();s?b(s):(O=null,z=null)}r(),e(document).trigger("import.detail.updated",t)}function p(e){"OK"===e.status?(O.response=e,O.importState=0,s(null,O.id),u(O,'<span class="label label-success">imported</span>',!0)):(O.importState=4,O.response=e.status,u(O,'<span class="label label-danger">failed</span>',!0))}function m(e){switch(e){case 0:return 3;case 500:return 5;default:return 101}}function f(e){O.response=e.responseText,s(null,O.id),"abort"!==e.statusText?(O.importState=m(e.status),u(O,'<span class="label label-danger">failed</span>',!0)):(O.importState=-2,u(O,'<span class="label label-warning">aborted</span>',!0))}function h(){if(M.url="/imp?fmt=json",2===O.retry&&(M.url+="&o=true"),M.xhr=o,M.data=new FormData,O.response&&O.response.columns){for(var e="",t=0;t<O.response.columns.length;t++){var n=O.response.columns[t];n.altType&&n.type!==n.altType&&(e+=n.name+"="+n.altType+"&")}console.log("schema: "+e),M.data.append("schema",e)}return M.data.append("data",O.file),M}function g(){u(O,'<span class="label label-info">importing</span>',!1),e("#"+O.id).append('<div class="ud-progress"></div>'),z=e.ajax(h()).done(p).fail(f),r()}function v(e){switch(e.status){case"EXISTS":O.importState=1,u(O,'<span class="label label-danger">exists</span>',!0);break;case"DOES_NOT_EXIST":O.importState=0,g();break;case"EXISTS_FOREIGN":O.importState=2,u(O,'<span class="label label-danger">reserved</span>',!0);break;default:O.importState=101,u(O,'<span class="label label-danger">failed</span>',!0)}}function b(t){O=t,t.retry?(O.importState=0,g()):(D.url="/chk?f=json&j="+t.name,e.ajax(D).then(v).fail(f))}function y(e,t){for(var n=0;n<t.files.length;n++){var a=t.files[n],i={id:guid(),name:a.name,size:a.size,file:a,sizeFmt:toSize(a.size),selected:!1,imported:!1};k[i.id]=i,c(i),null!=O?E.push(i):b(i)}}function w(){for(var t in k)if(k.hasOwnProperty(t)){var a=k[t];if(a.selected&&a!==O){var i=E.indexOf(a);i>-1&&delete E[i],e("#"+t).remove(),delete k[t],e(document).trigger("import.cleared",a)}}I=0;for(var s=T.find(".ud-row"),o=0;o<s.length;o++)e(s[o]).css("top",I),I+=q;n()}function $(){for(var e in k)if(k.hasOwnProperty(e)){var t=k[e];t.selected&&t.retry&&(null===O?b(t):E.push(t))}}function S(){null!==z&&z.abort()}function C(){e(document).on("dropbox.files",y),e(document).on("import.clearSelected",w),e(document).on("import.cancel",S),e(document).on("import.retry",$),e(document).on("import.line.overwrite",a),e(document).on("import.line.append",i),e(document).on("import.line.cancel",s)}function x(){j.append('<div class="ud-header-row"><div class="ud-header ud-h0">&nbsp;</div><div class="ud-header ud-h1">File name</div><div class="ud-header ud-h2">Size</div><div class="ud-header ud-h3">Status</div></div>'),j.append('<div class="ud-canvas"></div>'),T=j.find("> .ud-canvas"),C()}var T,k={},j=this,I=0,E=[],O=null,q=35,z=null,M={xhr:o,url:"/imp?fmt=json",type:"POST",contentType:!1,processData:!1,cache:!1},D={type:"GET",contentType:!1,processData:!1,cache:!1};return x(),this},e.fn.dropbox=function(){function t(){s.addClass("drag-drop").removeClass("drag-idle")}function n(){s.removeClass("drag-drop").addClass("drag-idle")}function a(){s.on("drop",function(t){n(),i=e(),e(document).trigger("dropbox.files",t.originalEvent.dataTransfer)}),s.each(function(){var a=e(this);a.on("dragenter",function(e){0===i.size()&&(nopropagation(e),t()),i=i.add(e.target)}),a.on("dragleave",function(e){setTimeout(function(){i=i.not(e.target),0===i.size()&&n()},1)})})}var i=e(),s=this;return a(),this}}(jQuery),$(document).ready(function(){$("#btnImportClearSelected").click(function(){$(document).trigger("import.clearSelected")}),$("#btnImportCancel").click(function(){$(document).trigger("import.cancel")}),$("#btnRetry").click(function(){$(document).trigger("import.retry")}),$("#dragTarget").dropbox(),$("#import-file-list").importManager(),$(document).on("dragenter",nopropagation),$(document).on("dragover",nopropagation),$(document).on("drop",nopropagation),$(document).ready(function(){$("input").iCheck({checkboxClass:"icheckbox_square-red",radioClass:"iradio_square-red"})})}),function(e){e.fn.importEditor=function(){function t(){var t=e(this);d.appendTo(t.parent()),d.css("left",t.css("left")),d.css("width",t.css("width"));var n=parseInt(e(this).parent().find(".js-g-row").text())-1,a=T.response.columns[n];a.altType?d.val(a.altType):d.val(a.type),d.changeTargetDiv=t,d.changeTargetCol=a,d.show(),d.focus()}function n(){d.hide()}function a(e){return e.altType&&e.altType!==e.type?e.type+'<i class="fa fa-angle-double-right g-type-separator"></i>'+e.altType:e.type}function i(){for(var t=!1,n=0;n<T.response.columns.length;n++){var a=T.response.columns[n];if(a.altType&&a.type!==a.altType){t=!0;break}}e(document).trigger(t?"import.line.overwrite":"import.line.cancel",T.id)}function s(){d.changeTargetCol.altType=e(this).find("option:selected").text(),d.changeTargetDiv.html(a(d.changeTargetCol)),i(),n()}function o(){e(".g-type").click(t),e(".g-other").click(n),d.change(s)}function r(e){if(e.response&&0===e.importState){h.html(e.response.location);var t=e.response.rowsImported,n=e.response.rowsRejected,i=t+n;if(g.css("width",Math.round(100*n/i)+"%"),v.css("width",Math.round(100*t/i)+"%"),b.html(n),y.html(t),w.empty(),e.response.columns)for(var s=0,r=0;r<e.response.columns.length;r++){var l=e.response.columns[r];w.append('<div class="ud-row" style="top: '+s+'px"><div class="ud-cell gc-1 g-other js-g-row">'+(r+1)+'</div><div class="ud-cell gc-2 g-other">'+(l.errors>0?'<i class="fa fa-exclamation-triangle g-warning"></i>':"")+l.name+'</div><div class="ud-cell gc-3 g-type">'+a(l)+'</div><div class="ud-cell gc-4 g-other">'+l.errors+"</div></div>"),s+=C}o(),p.show(),m.hide()}else{switch(e.importState){case 1:f.html("Journal <strong>"+e.name+"</strong> already exists on server"),$.show();break;case 2:f.html("Journal name <strong>"+e.name+"</strong> is reserved"),$.hide();break;case 3:f.html("Server is not responding..."),$.hide();break;case 4:f.html(e.response),$.hide();break;case 5:f.html("Server encountered internal problem. Check server logs for more details."),$.hide();break;default:f.html("Unknown error: "+e.responseStatus),$.hide()}p.hide(),m.show(),S.iCheck("uncheck")}c.show()}function l(){d=e('<select class="g-dynamic-select form-control m-b"/>');for(var t=0;t<x.length;t++){var n=x[t];e("<option />",{value:n,text:n}).appendTo(d)}}var d,c=e(this),u=e(".stats-switcher"),p=e(this).find(".js-import-editor"),m=e(this).find(".js-import-error"),f=e(this).find(".js-message"),h=e(this).find(".js-import-tab-name"),g=e(this).find(".import-rejected"),v=e(this).find(".import-imported"),b=e(this).find(".js-rejected-row-count"),y=e(this).find(".js-imported-row-count"),w=e(this).find(".ud-canvas"),$=e(this).find(".js-import-error-btn-group"),S=e('input:radio[name="importAction"]'),C=35,x=["BOOLEAN","BYTE","DOUBLE","FLOAT","INT","LONG","SHORT","STRING","SYMBOL","DATE"],T=null;e(document).on("import.detail",function(e,t){T=t,r(t)}),e(document).on("import.detail.updated",function(e,t){T===t&&t.response&&r(t)}),e(document).on("import.cleared",function(e,t){t===T&&(T=null,p.hide(),m.hide())}),l(),e(".import-stats-chart").click(function(){u.hasClass("stats-visible")?u.removeClass("stats-visible"):u.addClass("stats-visible")}),S.on("ifClicked",function(){var t;switch(this.value){case"append":t="import.line.append";break;case"overwrite":t="import.line.overwrite";break;default:t="import.line.cancel"}e(document).trigger(t,T.id)})}}(jQuery),$(document).ready(function(){$("#import-detail").importEditor()}),function(e){function t(){function t(){}function n(){null!==d&&(d.abort(),d=null)}function a(){null!==c&&(clearTimeout(c),c=null)}function i(){console.log("success")}function s(e,t){console.log("not so lucky: "+t)}function o(){n(),u.query=l,u.limit="0,100",u.withCount=!0,d=e.get("/js",u,i,s)}function r(e){l=e,a(),setTimeout(o,50)}var l,d=null,c=null,u={query:"",limit:"",withCount:!1};return t(),{sendQuery:r}}e.extend(!0,window,{nfsdb:{GridController:t}})}(jQuery),$(document).ready(function(){function e(){var e=$("body");!e.hasClass("mini-navbar")||e.hasClass("body-small")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},200)):e.hasClass("fixed-sidebar")?($("#side-menu").hide(),setTimeout(function(){$("#side-menu").fadeIn(400)},100)):$("#side-menu").removeAttr("style")}$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small"),$("#side-menu").metisMenu(),$(".navbar-minimalize").click(function(){$("body").toggleClass("mini-navbar"),e()}),$(".modal").appendTo("body"),fixHeight(),$(window).bind("load resize scroll",function(){$("body").hasClass("body-small")||fixHeight()})}),$(window).bind("resize",function(){$(this).width()<769?$("body").addClass("body-small"):$("body").removeClass("body-small")}),$(document).ready(function(){if(localStorageSupport){var e=localStorage.getItem("collapse_menu"),t=localStorage.getItem("fixednavbar"),n=localStorage.getItem("boxedlayout"),a=localStorage.getItem("fixedfooter"),i=$("body");"on"===e&&(i.hasClass("fixed-sidebar")?i.hasClass("body-small")||i.addClass("mini-navbar"):i.hasClass("body-small")||i.addClass("mini-navbar")),"on"===t&&($(".navbar-static-top").removeClass("navbar-static-top").addClass("navbar-fixed-top"),i.addClass("fixed-nav")),"on"===n&&i.addClass("boxed-layout"),"on"===a&&$(".footer").addClass("fixed")}}),$(document).ready(function(){var e=$(".sql-editor"),t=$(".file-upload");$("a#sql-editor").click(function(){e.css("display","block"),t.css("display","none"),$("#sqlEditor").css("height","240px")}),$("a#file-upload").click(function(){e.css("display","none"),t.css("display","block")});var n=ace.edit("sqlEditor");n.getSession().setMode("ace/mode/sql"),n.setTheme("ace/theme/merbivore_soft"),n.setShowPrintMargin(!1),n.setDisplayIndentGuides(!1),n.setHighlightActiveLine(!1),"undefined"!=typeof Storage&&localStorage.getItem("lastQuery")&&n.setValue(localStorage.getItem("lastQuery")),n.focus();var a=$("#grid");a.css("height","430px")});